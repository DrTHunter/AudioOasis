<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="index, follow">
  <meta name="author" content="Trent Hunter, AudioOasis by Orion AI">
  <!-- SEO Primary Meta Tags -->
  <title>AudioOasis | Free Studio-Quality Background Music for Work & Focus</title>
  <meta name="title" content="AudioOasis | Free Studio-Quality Background Music for Work & Focus" />
  <meta name="description" content="Stream high-quality .WAV music for deep work, focus, and flow. No ads. No distractions. Just curated background soundtracks for creators and thinkers." />
  <link rel="canonical" href="https://drthunter.github.io/AudioOasis/" />
  <!-- Open Graph Meta Tags -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://drthunter.github.io/AudioOasis/" />
  <meta property="og:title" content="AudioOasis | Free Studio-Quality Background Music for Work & Focus" />
  <meta property="og:description" content="Escape the noise. Discover a curated library of lofi and ambient .WAV tracks to help you focus, relax, and get things done." />
  <meta property="og:image" content="https://drthunter.github.io/AudioOasis/UI%20Picture.png" />
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="https://drthunter.github.io/AudioOasis/" />
  <meta name="twitter:title" content="AudioOasis | Free Studio-Quality Background Music for Work & Focus" />
  <meta name="twitter:description" content="Background music that doesn't get in the way. Explore studio-quality .WAV playlists made for deep work and calm vibes." />
  <meta name="twitter:image" content="https://drthunter.github.io/AudioOasis/UI%20Picture.png" />
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-55NPK2XL9R"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-55NPK2XL9R');
  </script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #3498db;
      --primary-dark: #2980b9;
      --secondary: #2c3e50;
      --accent: #2ecc71;
      --mixer-accent: #9b59b6;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --border-radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-hover: 0 6px 16px rgba(0,0,0,0.12);
      --transition: all 0.3s ease;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: var(--dark);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      line-height: 1.6;
    }
    /* Header */
    header {
      background: linear-gradient(135deg, var(--secondary) 0%, #1a252f 100%);
      color: white;
      padding: 0.6rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
    }
    .header-text {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 2px;
    }
    header h1 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      white-space: nowrap;
    }
    header h1 i {
      font-size: 1rem;
    }
    .tagline {
      margin: 0;
      font-size: 0.8rem;
      opacity: 0.6;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      min-width: 0;
    }
    /* Main Layout */
    .main-container {
      display: flex;
      flex: 1;
      padding: 20px;
      gap: 25px;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }
    /* Player Container */
    .player-container {
      flex: 1;
      max-width: 450px;
      min-width: 350px;
    }
    .library-container {
      flex: 2;
      min-width: 0; /* Prevent overflow */
    }
    /* ══════ Redesigned Player ══════ */
    .music-player {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      overflow: hidden;
    }

    /* ── Tabs (act as the header) ── */
    .player-tabs {
      display: flex;
      background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
      padding: 0;
    }
    .tab-btn {
      flex: 1;
      padding: 12px 16px;
      background: none;
      border: none;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.3px;
      cursor: pointer;
      color: rgba(255,255,255,0.5);
      transition: var(--transition);
      position: relative;
    }
    .tab-btn:hover {
      color: rgba(255,255,255,0.8);
    }
    .tab-btn.active {
      color: white;
    }
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 20%;
      right: 20%;
      height: 2px;
      border-radius: 2px;
      background: var(--primary);
    }
    .tab-btn.mixer.active::after {
      background: var(--mixer-accent);
    }
    .tab-content {
      display: none;
      padding: 16px;
    }
    .tab-content.active {
      display: block;
    }

    /* ── Track Info (compact) ── */
    .track-info {
      text-align: center;
      margin-bottom: 14px;
    }
    .track-title {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--dark);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }
    .track-category-label {
      font-size: 0.7rem;
      color: var(--gray);
      padding: 1px 8px;
      border-radius: 10px;
      background: #f1f3f5;
    }
    .track-status {
      font-size: 0.8rem;
      color: var(--gray);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 4px;
    }
    .track-status i { font-size: 0.7rem; }

    /* ── Progress Bar ── */
    .progress-container {
      margin-bottom: 8px;
    }
    .progress-bar {
      width: 100%;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--light-gray);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
      transition: height 0.15s ease;
    }
    .progress-bar:hover {
      height: 6px;
    }
    .progress-bar::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      box-shadow: 0 0 0 2px rgba(52,152,219,0.2);
    }
    .progress-bar::-moz-range-thumb {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: none;
    }
    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 0.72rem;
      color: var(--gray);
      margin-top: 3px;
      font-variant-numeric: tabular-nums;
    }

    /* ── Controls Row ── */
    .player-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 10px;
    }
    .control-btn {
      background: none;
      color: var(--gray);
      border: none;
      border-radius: 50%;
      width: 34px;
      height: 34px;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    .control-btn:hover {
      color: var(--dark);
      background: var(--light-gray);
    }
    .control-btn.primary {
      background: var(--primary);
      color: white;
      width: 42px;
      height: 42px;
      font-size: 1.05rem;
      box-shadow: 0 2px 8px rgba(52,152,219,0.3);
    }
    .control-btn.primary:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }
    .control-btn.active {
      color: var(--accent);
    }
    .control-btn.active:hover {
      background: rgba(46,204,113,0.12);
    }


    /* ── Volume (inline) ── */
    .volume-control {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--light-gray);
    }
    .volume-bar {
      flex: 1;
      height: 3px;
      -webkit-appearance: none;
      background: var(--light-gray);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
    }
    .volume-bar::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
    }
    .volume-bar::-moz-range-thumb {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: none;
    }
    .volume-control i {
      color: var(--gray);
      font-size: 0.85rem;
      width: 16px;
      text-align: center;
    }

    /* ── Mixer Tab ── */
    .mixer-container {
      max-height: 380px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .mixer-track {
      background: var(--light);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid transparent;
      transition: var(--transition);
    }
    .mixer-track:hover {
      border-color: rgba(155,89,182,0.3);
    }
    .mixer-track-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .mixer-track-title {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
      overflow: hidden;
    }
    .mixer-track-title span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .mixer-track-title i {
      color: var(--mixer-accent);
      font-size: 0.75rem;
      flex-shrink: 0;
    }
    .mixer-track-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }
    .mixer-control-btn {
      background: transparent;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: var(--gray);
      transition: var(--transition);
    }
    .mixer-control-btn:hover {
      background: var(--mixer-accent);
      color: white;
    }
    .mixer-control-btn.active {
      background: var(--mixer-accent);
      color: white;
    }
    .mixer-volume-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .mixer-volume-slider {
      flex: 1;
      height: 3px;
      -webkit-appearance: none;
      background: #ddd;
      border-radius: 2px;
      outline: none;
      cursor: pointer;
    }
    .mixer-volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--mixer-accent);
      cursor: pointer;
    }
    .mixer-volume-value {
      font-size: 0.72rem;
      color: var(--gray);
      min-width: 28px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .mixer-progress-container {
      margin-top: 8px;
    }
    .mixer-progress-bar {
      width: 100%;
      height: 3px;
      -webkit-appearance: none;
      appearance: none;
      background: #e0e0e0;
      border-radius: 2px;
      outline: none;
      cursor: pointer;
    }
    .mixer-progress-bar::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--mixer-accent);
      cursor: pointer;
    }
    .mixer-progress-bar::-moz-range-thumb {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--mixer-accent);
      cursor: pointer;
      border: none;
    }
    .mixer-time-display {
      display: flex;
      justify-content: space-between;
      font-size: 0.65rem;
      color: var(--gray);
      margin-top: 3px;
      font-variant-numeric: tabular-nums;
    }
    .empty-mixer {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }
    .empty-mixer i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: #ddd;
    }
    /* Playlist */
    .playlist {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 0;
      overflow: hidden;
      transition: var(--transition);
    }
    .playlist:hover {
      box-shadow: var(--shadow-hover);
    }
    .playlist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      padding: 10px 16px;
      cursor: pointer;
    }
    .playlist-header h2 {
      margin: 0;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .playlist-content {
      padding: 20px;
      /* more conservative height to keep playlist from growing too tall */
      max-height: 420px;
      overflow-y: auto;
      transition: max-height 0.3s ease;
    }
    .playlist.collapsed .playlist-content {
      max-height: 0;
      padding: 0 20px;
      overflow: hidden;
    }
    .playlist-items {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .playlist-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid transparent;
    }
    .playlist-item:hover {
      background-color: #f0f7ff;
      border-color: #cce5ff;
      transform: translateX(5px);
    }
    .playlist-item.active {
      background-color: #e1f5fe;
      border-color: #b3e5fc;
      font-weight: 600;
      color: var(--primary-dark);
    }
    .track-index {
      width: 30px;
      text-align: center;
      font-weight: 600;
      color: var(--gray);
    }
    .track-details {
    flex: 1;
    display: grid;
    /* left / center / right columns */
    grid-template-columns: 2fr 1.4fr 0.8fr;
    align-items: center;
    column-gap: 10px;
    }
    /* shared base for each column cell */
    .track-cell {
    display: flex;
    align-items: center;
    }
    /* left column: title, align left */
    .track-cell-left {
    justify-content: flex-start;
    }
    /* center column: category, truly centered */
    .track-cell-center {
    justify-content: center;
    }
    /* right column: duration, align right */
    .track-cell-right {
    justify-content: flex-end;
    }
    .track-name {
    font-size: 0.95rem;
    }
    /* For the pill in the playlist rows */
    .track-category-pill {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    min-width: 80px;
    text-align: center;
    font-size: 0.8rem;
    color: var(--gray);
    padding: 2px 10px;
    border-radius: 999px;
    background: #f1f3f5;
    }
    .track-duration {
    font-size: 0.85rem;
    color: var(--gray);
    background: var(--light-gray);
    padding: 3px 8px;
    border-radius: 10px;
    }
    .remove-track {
      opacity: 0;
      margin-left: 10px;
      color: #e74c3c;
      cursor: pointer;
      transition: var(--transition);
    }
    .playlist-item:hover .remove-track {
      opacity: 1;
    }
    .add-to-mixer-btn {
      opacity: 0;
      margin-left: 5px;
      color: var(--mixer-accent);
      cursor: pointer;
      transition: var(--transition);
    }
    .playlist-item:hover .add-to-mixer-btn {
      opacity: 1;
    }
    .empty-playlist {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }
    .empty-playlist i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: #ddd;
    }
       /* Saved Playlists */
    .saved-playlists {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 0;
      overflow: hidden;
      transition: var(--transition);
      margin-top: 25px;
    }
    .saved-playlists:hover {
      box-shadow: var(--shadow-hover);
    }
    .saved-playlists-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      padding: 10px 16px;
      cursor: pointer;
    }
    .saved-playlists-header h2 {
      margin: 0;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .saved-playlists-content {
      padding: 20px;
      transition: max-height 0.3s ease;
    }
    .saved-playlists.collapsed .saved-playlists-content {
      max-height: 0;
      padding: 0 20px;
      overflow: hidden;
    }
    .saved-playlist-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .saved-playlist-controls input {
      flex: 1;
      min-width: 0;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--light-gray);
      font-size: 0.9rem;
      transition: var(--transition);
    }
    .saved-playlist-controls input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
    }
    .save-dropdown {
      position: relative;
      display: inline-flex;
    }
    .save-dropdown .save-main-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 10px;
      border-radius: 8px 0 0 8px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
      font-size: 0.85rem;
    }
    .save-dropdown .save-main-btn:hover {
      background: var(--primary-dark);
    }
    .save-dropdown .save-arrow-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-left: 1px solid rgba(255,255,255,0.3);
      padding: 8px 6px;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.7rem;
    }
    .save-dropdown .save-arrow-btn:hover {
      background: var(--primary-dark);
    }
    .save-dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      z-index: 1000;
      min-width: 180px;
      overflow: hidden;
      margin-top: 4px;
    }
    body.dark-mode .save-dropdown-menu {
      background: #2a2a40;
    }
    .save-dropdown-menu.show {
      display: block;
    }
    .save-dropdown-menu button {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 10px 14px;
      border: none;
      background: none;
      color: var(--dark);
      font-size: 0.85rem;
      cursor: pointer;
      transition: var(--transition);
      text-align: left;
    }
    body.dark-mode .save-dropdown-menu button {
      color: #ccc;
    }
    .save-dropdown-menu button:hover {
      background: #f0f4ff;
    }
    body.dark-mode .save-dropdown-menu button:hover {
      background: #353555;
    }
    .save-dropdown-menu button i {
      width: 16px;
      text-align: center;
    }
    .saved-playlist-type-badge {
      display: inline-block;
      font-size: 0.7rem;
      padding: 1px 6px;
      border-radius: 4px;
      font-weight: 600;
      margin-left: 6px;
    }
    .saved-playlist-type-badge.type-all { background: #e8f5e9; color: #2e7d32; }
    .saved-playlist-type-badge.type-music { background: #e3f2fd; color: #1565c0; }
    .saved-playlist-type-badge.type-video { background: #fce4ec; color: #c62828; }
    body.dark-mode .saved-playlist-type-badge.type-all { background: rgba(46,125,50,0.25); color: #81c784; }
    body.dark-mode .saved-playlist-type-badge.type-music { background: rgba(21,101,192,0.25); color: #64b5f6; }
    body.dark-mode .saved-playlist-type-badge.type-video { background: rgba(198,40,40,0.25); color: #ef9a9a; }
    @media (max-width: 768px) {
      .saved-playlist-controls {
        flex-wrap: nowrap;
      }
      .saved-playlist-controls input {
        min-width: 0;
        padding: 8px 8px;
        font-size: 0.85rem;
      }
      .save-dropdown .save-main-btn {
        padding: 8px 8px;
        font-size: 0.8rem;
      }
      .save-dropdown .save-arrow-btn {
        padding: 8px 5px;
      }
    }
    .saved-playlists-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .saved-playlist-editing {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 12px 0 15px;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(52, 152, 219, 0.12);
      color: var(--secondary);
      font-size: 0.9rem;
      border: 1px solid rgba(52, 152, 219, 0.2);
    }
    .saved-playlist-editing span {
      font-weight: 600;
    }
    .saved-playlist-editing button {
      border: none;
      background: var(--secondary);
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: var(--transition);
    }
    .saved-playlist-editing button:hover {
      background: #1a252f;
    }
    .saved-playlist-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: #f8fbff;
      transition: var(--transition);
    }
    .saved-playlist-item.editing {
      border-color: rgba(52, 152, 219, 0.6);
      background: rgba(52, 152, 219, 0.08);
    }
    .saved-playlist-item:hover {
      border-color: #cce5ff;
      transform: translateX(3px);
    }
    .saved-playlist-details {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .saved-playlist-name {
      font-weight: 600;
      color: var(--dark);
    }
    .saved-playlist-meta {
      font-size: 0.85rem;
      color: var(--gray);
    }
    .saved-playlist-actions {
      display: flex;
      gap: 8px;
    }
    .saved-playlist-actions button {
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: var(--transition);
      background: var(--light-gray);
      color: var(--dark);
    }
    .saved-playlist-actions button:hover {
      background: var(--primary);
      color: white;
    }
    .saved-playlist-actions button.delete {
      background: #fdecea;
      color: #e74c3c;
    }
    .saved-playlist-actions button.delete:hover {
      background: #e74c3c;
      color: white;
    }
    .saved-playlists-empty {
      text-align: center;
      padding: 20px;
      color: var(--gray);
    }
    /* Confirmation Modal */
    .confirm-modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .confirm-modal-overlay.show {
      display: flex;
    }
    .confirm-modal {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 360px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      text-align: center;
    }
    body.dark-mode .confirm-modal {
      background: #2a2a40;
      color: #eee;
    }
    .confirm-modal h3 {
      margin: 0 0 8px;
      font-size: 1.1rem;
    }
    .confirm-modal p {
      margin: 0 0 20px;
      font-size: 0.9rem;
      color: var(--gray);
    }
    .confirm-modal-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .confirm-modal-actions button {
      padding: 8px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
      transition: var(--transition);
    }
    .confirm-modal-actions .confirm-cancel {
      background: var(--light-gray);
      color: var(--dark);
    }
    body.dark-mode .confirm-modal-actions .confirm-cancel {
      background: #3a3a5c;
      color: #ccc;
    }
    .confirm-modal-actions .confirm-delete {
      background: #e74c3c;
      color: white;
    }
    .confirm-modal-actions .confirm-delete:hover {
      background: #c0392b;
    }
    /* Trash Section */
    .trash-section {
      margin-top: 15px;
      border-top: 1px solid var(--light-gray);
      padding-top: 12px;
    }
    body.dark-mode .trash-section {
      border-top-color: #3a3a5c;
    }
    .trash-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 6px 0;
      color: var(--gray);
      font-size: 0.85rem;
    }
    .trash-header:hover {
      color: var(--dark);
    }
    body.dark-mode .trash-header:hover {
      color: #ccc;
    }
    .trash-header i {
      margin-right: 6px;
    }
    .trash-items {
      display: none;
      list-style: none;
      padding: 0;
      margin: 8px 0 0;
      flex-direction: column;
      gap: 8px;
    }
    .trash-items.show {
      display: flex;
    }
    .trash-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: 8px;
      background: #fef3f2;
      border: 1px solid #fdecea;
      font-size: 0.85rem;
      opacity: 0.8;
    }
    body.dark-mode .trash-item {
      background: rgba(231,76,60,0.08);
      border-color: rgba(231,76,60,0.2);
    }
    .trash-item-details {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .trash-item-name {
      font-weight: 600;
      color: var(--dark);
    }
    body.dark-mode .trash-item-name {
      color: #ccc;
    }
    .trash-item-meta {
      font-size: 0.75rem;
      color: var(--gray);
    }
    .trash-item-actions {
      display: flex;
      gap: 6px;
    }
    .trash-item-actions button {
      border: none;
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: var(--transition);
    }
    .trash-item-actions .restore-btn {
      background: var(--accent);
      color: white;
    }
    .trash-item-actions .restore-btn:hover {
      background: #27ae60;
    }
    .trash-item-actions .perm-delete-btn {
      background: #fdecea;
      color: #e74c3c;
    }
    .trash-item-actions .perm-delete-btn:hover {
      background: #e74c3c;
      color: white;
    }
    body.dark-mode .trash-item-actions .perm-delete-btn {
      background: rgba(231,76,60,0.15);
    }
    /* Library */
    .library-wrapper {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 0;
      overflow: hidden;
      transition: var(--transition);
    }
    .library-wrapper:hover {
      box-shadow: var(--shadow-hover);
    }
    .library-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      padding: 10px 16px;
      cursor: pointer;
    }
    .library-header h2 {
      margin: 0;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .library-body {
      padding: 20px;
    }
    .instructions {
      text-align: center;
      padding: 10px 20px;
      margin-bottom: 15px;
      font-size: 0.85rem;
      color: var(--gray);
    }
    .instructions i {
      color: var(--gray);
      font-size: 0.85rem;
    }
    .library-grid {
      display: flex;
      flex-direction: column;
      gap: 0;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .category {
      background-color: white;
      padding: 0;
      overflow: hidden;
      transition: background-color 0.2s ease;
      border-bottom: 1px solid var(--light-gray);
    }
    .category:last-child {
      border-bottom: none;
    }
    .category.drag-over {
      border-top: 3px solid var(--primary);
    }
    .category.dragging {
      opacity: 0.5;
    }
    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: transparent;
      color: var(--dark);
      padding: 8px 16px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      user-select: none;
    }
    .category-header:hover {
      background: #f0f4ff;
    }
    .category.expanded .category-header {
      background: linear-gradient(135deg, #3a4a8a 0%, #4e3570 100%);
      color: white;
    }
    .category-header h3 {
      margin: 0;
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .category-header .track-count {
      font-weight: 400;
      font-size: 0.75rem;
      opacity: 0.7;
    }
    .category-drag-handle {
      cursor: grab;
      color: var(--gray);
      font-size: 0.9rem;
      padding: 4px 6px;
      opacity: 0.4;
      transition: opacity 0.2s;
    }
    .category-header:hover .category-drag-handle {
      opacity: 1;
    }
    .toggle-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      color: inherit;
      padding: 4px;
      font-size: 1rem;
    }
    .category .toggle-btn {
      color: var(--gray);
      background: transparent;
    }
    .category .add-all-btn {
      color: var(--primary);
      border-color: var(--primary);
      background: transparent;
    }
    .category.expanded .category-header .category-drag-handle,
    .category.expanded .category-header .toggle-btn {
      color: rgba(255,255,255,0.8);
    }
    .category.expanded .toggle-btn {
      background: transparent;
    }
    .category.expanded .add-all-btn {
      color: white;
      border-color: rgba(255,255,255,0.4);
      background: rgba(255,255,255,0.15);
    }
    .category-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.35s ease;
    }
    .category.expanded .category-content {
      max-height: 400px;
      overflow-y: auto;
    }
    .category-tracks {
      padding: 8px 15px 15px;
      position: relative;
    }
    .category-tracks-spacer {
      width: 100%;
    }
    .category-track {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 4px;
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.93rem;
    }
    .category-track:hover {
      background-color: #f0f4ff;
    }
    .category-track .track-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-shrink: 0;
    }
    /* Dark Mode - library accordion overrides */
    body.dark-mode .library-grid {
      background: #1e1e2f;
    }
    body.dark-mode .category {
      background-color: #1e1e2f;
      border-color: #3a3a5c;
    }
    body.dark-mode .category-header {
      color: #e0e0e0;
    }
    body.dark-mode .category-header:hover {
      background: #252540;
    }
    body.dark-mode .category.expanded .category-header {
      background: linear-gradient(135deg, #2e3a6e 0%, #3d2858 100%);
      color: white;
    }
    body.dark-mode .category-track:hover {
      background-color: #252540;
    }
    .add-to-playlist-btn, .add-to-mixer-btn {
      opacity: 0;
      transition: var(--transition);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      border: none;
    }
    .add-to-playlist-btn {
      background: var(--primary);
      color: white;
    }
    .add-to-mixer-btn {
      background: var(--mixer-accent);
      color: white;
    }
    .category-track:hover .add-to-playlist-btn,
    .category-track:hover .add-to-mixer-btn {
      opacity: 1;
    }
    /* Mobile: first tap highlights track and shows buttons */
    .category-track.mobile-active {
      background-color: #f0f4ff;
    }
    .category-track.mobile-active .add-to-playlist-btn,
    .category-track.mobile-active .add-to-mixer-btn {
      opacity: 1;
    }
    body.dark-mode .category-track.mobile-active {
      background-color: #252540;
    }
    /* Footer */
    footer {
      text-align: center;
      padding: 20px;
      background: var(--secondary);
      color: rgba(255,255,255,0.7);
      font-size: 0.9rem;
      margin-top: 30px;
    }
    /* Responsive Design */
    @media (max-width: 1024px) {
      .main-container {
        flex-direction: column;
      }
      .player-container {
        max-width: 100%;
      }
    }
    @media (max-width: 768px) {
      .player-controls {
        gap: 4px;
      }
      .control-btn { width: 30px; height: 30px; font-size: 0.8rem; }
      .control-btn.primary { width: 36px; height: 36px; font-size: 0.95rem; }
      header h1 {
        font-size: 1.1rem;
      }
      header {
        flex-wrap: wrap;
        gap: 4px 12px;
        padding: 0.5rem 1rem;
      }
      .tagline {
        white-space: normal;
        text-align: center;
      }
      .mixer-track-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
      .mixer-track-controls {
        width: 100%;
        justify-content: flex-end;
      }
    }
    /* Search Bar */
    .library-search {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      position: relative;
    }
    .library-search input {
      flex: 1;
      padding: 12px 16px 12px 42px;
      border-radius: 10px;
      border: 2px solid var(--light-gray);
      font-size: 1rem;
      transition: var(--transition);
      background: white;
      color: var(--dark);
    }
    .library-search input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.12);
    }
    .library-search i {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      font-size: 1rem;
      pointer-events: none;
    }
    .search-clear {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      font-size: 1rem;
      display: none;
      pointer-events: all;
    }
    .search-clear.visible {
      display: block;
    }
    .search-stats {
      font-size: 0.85rem;
      color: var(--gray);
      margin-bottom: 12px;
      display: none;
    }
    .search-stats.visible {
      display: block;
    }
    .category-track.search-hidden {
      display: none;
    }
    .category.search-hidden {
      display: none;
    }
    /* Dark Mode */
    body.dark-mode {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e0e0e0;
    }
    body.dark-mode .music-player,
    body.dark-mode .playlist,
    body.dark-mode .saved-playlists,
    body.dark-mode .library-wrapper,
    body.dark-mode .category {
      background-color: #1e1e2f;
      color: #e0e0e0;
    }
    body.dark-mode .instructions {
      background-color: transparent;
      color: #6c757d;
    }
    body.dark-mode .player-tabs {
      background: linear-gradient(135deg, #1a1a2e 0%, #0d0d1a 100%);
    }
    body.dark-mode .tab-btn {
      color: rgba(255,255,255,0.4);
    }
    body.dark-mode .tab-btn.active {
      color: white;
    }
    body.dark-mode .track-title {
      color: #e0e0e0;
    }
    body.dark-mode .volume-control {
      border-color: #3a3a5c;
    }
    body.dark-mode .control-btn {
      background: none;
      color: #999;
    }
    body.dark-mode .control-btn:hover {
      color: #e0e0e0;
      background: #3a3a5c;
    }
    body.dark-mode .control-btn.primary {
      background: var(--primary);
      color: white;
    }
    body.dark-mode .control-btn.active {
      color: var(--accent);
    }
    body.dark-mode .mixer-track {
      background: #252540;
      border-color: transparent;
      color: #e0e0e0;
    }
    body.dark-mode .mixer-track:hover {
      border-color: rgba(155,89,182,0.3);
    }
    body.dark-mode .mixer-track-title {
      color: #e0e0e0;
    }
    body.dark-mode .mixer-control-btn {
      background: transparent;
      color: #999;
    }
    body.dark-mode .playlist-item {
      color: #e0e0e0;
    }
    body.dark-mode .playlist-item:hover {
      background-color: #2a2a45;
      border-color: #3a3a5c;
    }
    body.dark-mode .playlist-item.active {
      background-color: #1a3a5c;
      border-color: #2a5a8c;
    }
    body.dark-mode .category-track:hover {
      background-color: #2a2a45;
    }
    body.dark-mode .track-category-pill,
    body.dark-mode .track-category-label {
      background: #3a3a5c;
      color: #aaa;
    }
    body.dark-mode .track-duration {
      background: #3a3a5c;
      color: #aaa;
    }
    body.dark-mode .saved-playlist-item {
      background: #252540;
      color: #e0e0e0;
    }
    body.dark-mode .saved-playlist-item:hover {
      border-color: #3a3a5c;
    }
    body.dark-mode .saved-playlist-actions button {
      background: #3a3a5c;
      color: #ccc;
    }
    body.dark-mode .saved-playlist-controls input {
      background: #252540;
      color: #e0e0e0;
      border-color: #3a3a5c;
    }
    body.dark-mode .library-search input {
      background: #252540;
      color: #e0e0e0;
      border-color: #3a3a5c;
    }
    body.dark-mode .progress-bar,
    body.dark-mode .volume-bar,
    body.dark-mode .mixer-volume-slider,
    body.dark-mode .mixer-progress-bar {
      background: #3a3a5c;
    }
    body.dark-mode footer {
      background: #0d0d1a;
    }
    body.dark-mode ::-webkit-scrollbar-track {
      background: #1e1e2f;
    }
    body.dark-mode ::-webkit-scrollbar-thumb {
      background: #3a3a5c;
    }
    /* Dark mode toggle button */
    .dark-mode-toggle {
      background: rgba(255,255,255,0.15);
      border: 2px solid rgba(255,255,255,0.25);
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: var(--transition);
      flex-shrink: 0;
      margin-left: auto;
    }
    .dark-mode-toggle:hover {
      background: rgba(255,255,255,0.25);
      transform: scale(1.1);
    }
    body.dark-mode .dark-mode-toggle {
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.15);
    }
    /* Master Mixer Controls */
    .mixer-master-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .mixer-master-btn {
      flex: 1;
      min-width: 80px;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .mixer-master-btn.play-all {
      background: var(--mixer-accent);
      color: white;
    }
    .mixer-master-btn.pause-all {
      background: #e67e22;
      color: white;
    }
    .mixer-master-btn.stop-all {
      background: #e74c3c;
      color: white;
    }
    .mixer-master-btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.1);
    }
    /* Loading indicator */
    .track-loading {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(52,152,219,0.3);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 6px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .mixer-track .track-loading {
      border-top-color: var(--mixer-accent);
    }
    /* Add All button */
    .add-all-btn {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }
    .add-all-btn:hover {
      background: rgba(255,255,255,0.35);
      transform: scale(1.05);
    }
    .category-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .category-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    /* Utility Classes */
    .hidden {
      display: none !important;
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(52, 152, 219, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(52, 152, 219, 0);
      }
    }
    /* ══════ Video Player ══════ */
    .video-player-wrapper {
      position: relative;
      background: #000;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
      overflow: hidden;
      aspect-ratio: 16/9;
      max-height: 300px;
    }
    .video-player-wrapper.hidden { display: none; }
    .video-player-wrapper video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .video-player-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      opacity: 0;
      transition: opacity 0.3s;
    }
    .video-player-wrapper:hover .video-player-controls { opacity: 1; }
    .video-player-controls button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 0.8rem;
      padding: 4px 6px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .video-player-controls button:hover { background: rgba(255,255,255,0.2); }
    .video-now-playing {
      flex: 1;
      color: rgba(255,255,255,0.8);
      font-size: 0.7rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Video Settings Panel */
    .video-settings {
      background: #f8f9fa;
      padding: 10px 14px;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 0.75rem;
    }
    body.dark-mode .video-settings { background: #1a1a2e; border-color: #3a3a5c; }
    .video-settings label {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--gray);
      white-space: nowrap;
    }
    .video-settings select,
    .video-settings input[type="number"] {
      padding: 3px 6px;
      border: 1px solid var(--light-gray);
      border-radius: 4px;
      font-size: 0.75rem;
      background: white;
      width: 50px;
    }
    body.dark-mode .video-settings select,
    body.dark-mode .video-settings input[type="number"] {
      background: #252540;
      border-color: #3a3a5c;
      color: #e0e0e0;
    }
    .video-settings select { width: auto; }
    .video-settings .vs-divider {
      width: 1px;
      height: 18px;
      background: var(--light-gray);
    }
    body.dark-mode .video-settings .vs-divider { background: #3a3a5c; }
    .video-loop-toggle {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      color: var(--gray);
    }
    .video-loop-toggle.active { color: var(--primary); }
    .video-loop-toggle i { font-size: 0.85rem; }

    /* Playlist sub-tabs (Tracks / Videos) */
    .playlist-subtabs {
      display: flex;
      border-bottom: 1px solid var(--light-gray);
    }
    body.dark-mode .playlist-subtabs { border-color: #3a3a5c; }
    .playlist-subtab {
      flex: 1;
      padding: 8px 12px;
      background: none;
      border: none;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--gray);
      cursor: pointer;
      position: relative;
      transition: var(--transition);
    }
    .playlist-subtab:hover { color: var(--dark); }
    body.dark-mode .playlist-subtab:hover { color: #e0e0e0; }
    .playlist-subtab.active { color: var(--primary); }
    .playlist-subtab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 20%;
      right: 20%;
      height: 2px;
      border-radius: 2px;
      background: var(--primary);
    }
    .playlist-subcontent { display: none; }
    .playlist-subcontent.active { display: block; }

    /* Video playlist items */
    .video-playlist-items {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .video-playlist-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-bottom: 1px solid var(--light-gray);
      cursor: pointer;
      transition: background 0.2s;
      font-size: 0.8rem;
    }
    body.dark-mode .video-playlist-item { border-color: #3a3a5c; }
    .video-playlist-item:hover { background: #f0f4ff; }
    body.dark-mode .video-playlist-item:hover { background: #252540; }
    .video-playlist-item.active { background: rgba(52,152,219,0.1); }
    .video-playlist-item .vpi-index {
      width: 20px;
      text-align: center;
      color: var(--gray);
      font-size: 0.7rem;
    }
    .video-playlist-item .vpi-thumb {
      width: 48px;
      height: 28px;
      border-radius: 3px;
      object-fit: cover;
      background: #000;
      flex-shrink: 0;
    }
    .video-playlist-item .vpi-title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .video-playlist-item .vpi-remove {
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      padding: 2px 4px;
      font-size: 0.75rem;
    }
    .video-playlist-item .vpi-remove:hover { color: #e74c3c; }
    .empty-video-playlist {
      text-align: center;
      padding: 20px;
      color: var(--gray);
      font-size: 0.85rem;
    }

    /* ══════ Video Library ══════ */
    .video-library-wrapper {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: var(--transition);
      margin-top: 20px;
    }
    .video-library-wrapper:hover { box-shadow: var(--shadow-hover); }
    body.dark-mode .video-library-wrapper {
      background-color: #1e1e2f;
      color: #e0e0e0;
    }
    .video-library-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      padding: 10px 16px;
      cursor: pointer;
    }
    .video-library-header h2 {
      margin: 0;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .video-library-body { padding: 12px; }
    .video-library-body.hidden { display: none; }

    /* View toggle */
    .video-view-toggle {
      display: flex;
      gap: 4px;
      margin-bottom: 10px;
    }
    .video-view-btn {
      padding: 4px 10px;
      border: 1px solid var(--light-gray);
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
      color: var(--gray);
      transition: var(--transition);
    }
    .video-view-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    body.dark-mode .video-view-btn {
      background: #252540;
      border-color: #3a3a5c;
      color: #999;
    }
    body.dark-mode .video-view-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Video grid */
    .video-grid {
      display: grid;
      gap: 8px;
    }
    .video-grid.horizontal {
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    }
    .video-grid.vertical {
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    }
    .video-thumb-card {
      position: relative;
      border-radius: 6px;
      overflow: hidden;
      cursor: pointer;
      background: #000;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .video-thumb-card:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .video-thumb-card video,
    .video-thumb-card img {
      width: 100%;
      display: block;
      pointer-events: none;
    }
    .video-grid.horizontal .video-thumb-card video,
    .video-grid.horizontal .video-thumb-card img { aspect-ratio: 16/9; object-fit: cover; }
    .video-grid.vertical .video-thumb-card video,
    .video-grid.vertical .video-thumb-card img { aspect-ratio: 9/16; object-fit: cover; }
    .video-thumb-card .thumb-play-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: rgba(255,255,255,0.8);
      font-size: 1.8rem;
      pointer-events: none;
      text-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }
    .video-thumb-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 4px 6px;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      color: white;
      font-size: 0.65rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .video-thumb-actions {
      position: absolute;
      top: 4px;
      right: 4px;
      display: flex;
      gap: 3px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .video-thumb-card:hover .video-thumb-actions { opacity: 1; }
    .video-thumb-actions button {
      background: rgba(0,0,0,0.6);
      border: none;
      color: white;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .video-thumb-actions button:hover { background: var(--primary); }

    /* Video category headers in library */
    .video-category-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--gray);
      padding: 8px 4px 4px;
      border-bottom: 1px solid var(--light-gray);
      margin-bottom: 6px;
    }
    body.dark-mode .video-category-label { border-color: #3a3a5c; }

    /* Detached / Ambiance view */
    .video-ambiance-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 9999;
      background: #000;
    }
    .video-ambiance-overlay.active { display: flex; align-items: center; justify-content: center; }
    .video-ambiance-overlay video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .video-ambiance-controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      padding: 8px 14px;
      background: rgba(0,0,0,0.6);
      border-radius: 20px;
      z-index: 10000;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .video-ambiance-overlay:hover .video-ambiance-controls { opacity: 1; }
    .video-ambiance-controls button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .video-ambiance-controls button:hover { background: rgba(255,255,255,0.2); }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    /* ══════ Auth Modal ══════ */
    .auth-modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }
    .auth-modal-overlay.show { display: flex; }
    .auth-modal {
      background: white;
      border-radius: 16px;
      padding: 32px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalIn 0.25s ease;
    }
    @keyframes modalIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .auth-modal h2 {
      margin: 0 0 6px 0;
      font-size: 1.4rem;
      color: var(--secondary);
    }
    .auth-modal .auth-subtitle {
      color: var(--gray);
      font-size: 0.85rem;
      margin-bottom: 20px;
    }
    .auth-modal input[type="text"],
    .auth-modal input[type="email"],
    .auth-modal input[type="password"] {
      width: 100%;
      padding: 12px 14px;
      border: 1.5px solid var(--light-gray);
      border-radius: 10px;
      font-size: 0.95rem;
      margin-bottom: 12px;
      outline: none;
      transition: border-color 0.2s;
    }
    .auth-modal input:focus {
      border-color: var(--primary);
    }
    .auth-modal .auth-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
      margin-bottom: 12px;
    }
    .auth-modal .auth-btn:hover { opacity: 0.9; }
    .auth-modal .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .auth-modal .auth-toggle {
      text-align: center;
      font-size: 0.85rem;
      color: var(--gray);
    }
    .auth-modal .auth-toggle a {
      color: var(--primary);
      cursor: pointer;
      font-weight: 600;
      text-decoration: none;
    }
    .auth-modal .auth-error {
      background: #fee;
      color: #c0392b;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-bottom: 12px;
      display: none;
    }
    .auth-modal .auth-error.show { display: block; }
    body.dark-mode .auth-modal {
      background: #1e1e2f;
      color: #e0e0e0;
    }
    body.dark-mode .auth-modal h2 { color: #e0e0e0; }
    body.dark-mode .auth-modal input {
      background: #252540;
      border-color: #3a3a5c;
      color: #e0e0e0;
    }

    /* ══════ User Button (Header) ══════ */
    .user-btn {
      background: none;
      border: 1.5px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: rgba(255,255,255,0.8);
      font-size: 1rem;
      transition: var(--transition);
      position: relative;
      flex-shrink: 0;
    }
    .user-btn:hover {
      border-color: rgba(255,255,255,0.6);
      color: white;
      background: rgba(255,255,255,0.1);
    }
    .user-btn.logged-in {
      border-color: var(--accent);
      color: var(--accent);
    }
    .user-btn.logged-in:hover {
      background: rgba(46,204,113,0.15);
    }
    /* User dropdown */
    .user-dropdown {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      min-width: 200px;
      z-index: 9999;
      overflow: hidden;
    }
    .user-dropdown.show { display: block; }
    .user-dropdown-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--light-gray);
      font-size: 0.85rem;
    }
    .user-dropdown-header strong {
      display: block;
      font-size: 0.95rem;
      margin-bottom: 2px;
    }
    .user-dropdown-header span {
      color: var(--gray);
    }
    .user-dropdown button {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 12px 16px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--dark);
      transition: background 0.15s;
    }
    .user-dropdown button:hover { background: var(--light-gray); }
    .user-dropdown button.logout-btn { color: #e74c3c; }
    .user-dropdown button.logout-btn:hover { background: #fee; }
    body.dark-mode .user-dropdown {
      background: #1e1e2f;
      border-color: #3a3a5c;
    }
    body.dark-mode .user-dropdown-header { border-color: #3a3a5c; }
    body.dark-mode .user-dropdown button { color: #e0e0e0; }
    body.dark-mode .user-dropdown button:hover { background: #252540; }

    /* ══════ Heart / Favorite Button ══════ */
    .fav-btn {
      opacity: 0;
      transition: var(--transition);
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 0.85rem;
      border: none;
      background: none;
      color: var(--gray);
    }
    .fav-btn:hover { color: #e74c3c; }
    .fav-btn.hearted { color: #e74c3c; opacity: 1 !important; }
    .category-track:hover .fav-btn,
    .category-track.mobile-active .fav-btn { opacity: 1; }

    /* ══════ Community Playlists Section ══════ */
    .community-section {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-top: 16px;
    }
    .community-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      cursor: pointer;
      transition: background 0.2s;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
    }
    .community-header:hover { background: var(--light-gray); }
    .community-header h2 {
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .community-body { padding: 0 16px 16px; }
    .community-body.hidden { display: none; }
    .community-list { list-style: none; padding: 0; }
    .community-card {
      padding: 14px;
      border: 1px solid var(--light-gray);
      border-radius: 10px;
      margin-bottom: 10px;
      transition: var(--transition);
    }
    .community-card:hover { box-shadow: var(--shadow-hover); }
    .community-card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .community-card-name {
      font-weight: 600;
      font-size: 0.95rem;
    }
    .community-card-meta {
      font-size: 0.8rem;
      color: var(--gray);
      display: flex;
      gap: 12px;
    }
    .community-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .community-card-actions button {
      padding: 6px 14px;
      border: none;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    .community-like-btn {
      background: #fee;
      color: #e74c3c;
    }
    .community-like-btn.liked { background: #e74c3c; color: white; }
    .community-load-btn {
      background: var(--primary);
      color: white;
    }
    .community-load-btn:hover { opacity: 0.9; }
    .community-empty {
      text-align: center;
      padding: 24px;
      color: var(--gray);
      font-size: 0.9rem;
    }
    .community-share-form {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
    }
    .community-share-form input {
      flex: 1;
      padding: 10px 12px;
      border: 1.5px solid var(--light-gray);
      border-radius: 8px;
      font-size: 0.9rem;
      outline: none;
    }
    .community-share-form input:focus { border-color: var(--primary); }
    .community-share-form button {
      padding: 10px 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    body.dark-mode .community-section { background: #1e1e2f; }
    body.dark-mode .community-header:hover { background: #252540; }
    body.dark-mode .community-card { border-color: #3a3a5c; }
    body.dark-mode .community-share-form input {
      background: #252540;
      border-color: #3a3a5c;
      color: #e0e0e0;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-text">
      <h1><i class="fas fa-headphones"></i> AudioOasis</h1>
      <p class="tagline">Build your own background mix: lofi, ambience, meditation, and more. Click tracks to add them to your playlist or mixer.</p>
    </div>
    <div style="position:relative;">
      <button class="user-btn" id="user-btn" title="Account">
        <i class="fas fa-user"></i>
      </button>
      <div class="user-dropdown" id="user-dropdown">
        <div class="user-dropdown-header" id="user-dropdown-header">
          <strong id="user-dropdown-name">Guest</strong>
          <span id="user-dropdown-email"></span>
        </div>
        <button id="user-favorites-btn"><i class="fas fa-heart"></i> My Favorites</button>
        <button id="user-history-btn"><i class="fas fa-history"></i> Listening History</button>
        <button class="logout-btn" id="user-logout-btn"><i class="fas fa-sign-out-alt"></i> Log Out</button>
      </div>
    </div>
    <button class="dark-mode-toggle" id="dark-mode-toggle" title="Toggle dark mode">
      <i class="fas fa-moon"></i>
    </button>
  </header>
  <div class="main-container">
    <!-- Left side - Player and Playlist -->
    <div class="player-container">
      <!-- Video Player (above music player) -->
      <div class="video-player-wrapper hidden" id="video-player-wrapper">
        <video id="ambiance-video" muted playsinline></video>
        <div class="video-player-controls">
          <span class="video-now-playing" id="video-now-playing">No video</span>
          <button id="video-prev-btn" title="Previous video"><i class="fas fa-step-backward"></i></button>
          <button id="video-playpause-btn" title="Play/Pause video"><i class="fas fa-play"></i></button>
          <button id="video-next-btn" title="Next video"><i class="fas fa-step-forward"></i></button>
          <button id="video-detach-btn" title="Ambiance view"><i class="fas fa-external-link-alt"></i></button>
          <button id="video-fullscreen-btn" title="Fullscreen"><i class="fas fa-expand"></i></button>
          <button id="video-close-btn" title="Close video"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <!-- Video Settings -->
      <div class="video-settings hidden" id="video-settings">
        <label>Mode:
          <select id="video-interval-mode">
            <option value="per-track">Per Music Track</option>
            <option value="timed">Timed Interval</option>
            <option value="manual">Manual</option>
          </select>
        </label>
        <div class="vs-divider"></div>
        <label id="video-interval-time-label" class="hidden">Every
          <input type="number" id="video-interval-min" value="1" min="0" max="60"> m
          <input type="number" id="video-interval-sec" value="0" min="0" max="59"> s
        </label>
        <div class="vs-divider"></div>
        <span class="video-loop-toggle active" id="video-loop-toggle" title="Loop videos">
          <i class="fas fa-redo"></i> Loop
        </span>
      </div>
      <!-- Music Player -->
      <div class="music-player">
        <div class="player-tabs">
          <button class="tab-btn active" id="single-tab"><i class="fas fa-play-circle"></i> Player</button>
          <button class="tab-btn mixer" id="mixer-tab"><i class="fas fa-sliders-h"></i> Mixer</button>
        </div>
        <!-- Single Player Tab -->
        <div class="tab-content active" id="single-player-content">
          <div class="track-info">
            <div class="track-title" id="current-track">No Track Selected</div>
            <div class="track-status">
              <span id="playlist-count">0 tracks in playlist</span>
              <span id="current-category" class="track-category-label"></span>
            </div>
          </div>
          <div class="progress-container">
            <input type="range" id="progress-bar" class="progress-bar" value="0" max="100">
            <div class="time-display">
              <span id="current-time">0:00</span>
              <span id="duration">0:00</span>
            </div>
          </div>
          <div class="player-controls">
            <button class="control-btn" id="shuffle-btn" title="Shuffle"><i class="fas fa-random"></i></button>
            <button class="control-btn" id="prev-btn" title="Previous"><i class="fas fa-step-backward"></i></button>
            <button class="control-btn primary" id="play-btn" title="Play/Pause"><i class="fas fa-play"></i></button>
            <button class="control-btn" id="next-btn" title="Next"><i class="fas fa-step-forward"></i></button>
            <button class="control-btn" id="loop-btn" title="Loop"><i class="fas fa-redo"></i></button>
            <button class="control-btn" id="clear-btn" title="Clear"><i class="fas fa-trash"></i></button>
          </div>
          <div class="volume-control">
            <i class="fas fa-volume-down"></i>
            <input type="range" id="volume-bar" class="volume-bar" min="0" max="100" value="100">
            <i class="fas fa-volume-up"></i>
          </div>
          <audio id="audio-player"></audio>
        </div>
        <!-- Mixer Tab -->
        <div class="tab-content" id="mixer-content">
          <div class="mixer-container" id="mixer-tracks">
            <div class="mixer-master-controls hidden" id="mixer-master-controls">
              <button class="mixer-master-btn play-all" id="mixer-play-all"><i class="fas fa-play"></i> Play All</button>
              <button class="mixer-master-btn pause-all" id="mixer-pause-all"><i class="fas fa-pause"></i> Pause All</button>
              <button class="mixer-master-btn stop-all" id="mixer-stop-all"><i class="fas fa-stop"></i> Stop All</button>
            </div>
            <div class="empty-mixer" id="empty-mixer">
              <i class="fas fa-sliders-h"></i>
              <h3>Mixer is empty</h3>
              <p>Add tracks from the library or playlist to create your mix</p>
            </div>
            <!-- Mixer tracks will be added here dynamically -->
          </div>
        </div>
      </div>
      <!-- Playlist -->
      <div class="playlist" id="playlist">
        <div class="playlist-header" id="playlist-header">
          <h2><i class="fas fa-list"></i> Your Playlist</h2>
          <button class="toggle-btn" id="playlist-toggle">
            <i class="fas fa-chevron-up"></i>
          </button>
        </div>
        <div class="playlist-content" id="playlist-content">
          <div class="playlist-subtabs">
            <button class="playlist-subtab active" id="tracks-subtab"><i class="fas fa-music"></i> Tracks</button>
            <button class="playlist-subtab" id="videos-subtab"><i class="fas fa-film"></i> Videos</button>
          </div>
          <div class="playlist-subcontent active" id="tracks-subcontent">
            <div class="empty-playlist" id="empty-playlist">
              <i class="fas fa-music"></i>
              <h3>Your playlist is empty</h3>
              <p>Click any track from the Music Library to add it here</p>
            </div>
            <ul class="playlist-items" id="playlist-items"></ul>
          </div>
          <div class="playlist-subcontent" id="videos-subcontent">
            <div class="empty-video-playlist" id="empty-video-playlist">
              <i class="fas fa-film"></i>
              <p>No videos in playlist. Add videos from the Video Library below.</p>
            </div>
            <ul class="video-playlist-items" id="video-playlist-items"></ul>
          </div>
        </div>
      </div>
            <div class="saved-playlists" id="saved-playlists">
        <div class="saved-playlists-header" id="saved-playlists-header">
          <h2><i class="fas fa-save"></i> Saved Playlists</h2>
          <button class="toggle-btn" id="saved-playlists-toggle">
            <i class="fas fa-chevron-up"></i>
          </button>
        </div>
        <div class="saved-playlists-content">
          <div class="saved-playlist-controls">
            <input type="text" id="playlist-name-input" placeholder="Playlist name">
            <div class="save-dropdown">
              <button class="save-main-btn" id="save-playlist-btn">Save All</button>
              <button class="save-arrow-btn" id="save-dropdown-toggle"><i class="fas fa-chevron-down"></i></button>
              <div class="save-dropdown-menu" id="save-dropdown-menu">
                <button data-save-type="all"><i class="fas fa-layer-group"></i> Save All (Music + Videos)</button>
                <button data-save-type="music"><i class="fas fa-music"></i> Save Music Only</button>
                <button data-save-type="video"><i class="fas fa-film"></i> Save Videos Only</button>
              </div>
            </div>
          </div>
          <div class="saved-playlist-editing hidden" id="saved-playlist-editing">
            <span>Editing "<strong id="editing-playlist-name"></strong>"</span>
            <button id="done-edit-btn" type="button">Done</button>
          </div>
          <ul class="saved-playlists-list" id="saved-playlists-list">
            <li class="saved-playlists-empty">No saved playlists yet.</li>
          </ul>
          <!-- Trash Section -->
          <div class="trash-section" id="trash-section" style="display:none;">
            <div class="trash-header" id="trash-header">
              <span><i class="fas fa-trash"></i> Trash</span>
              <i class="fas fa-chevron-down" id="trash-chevron"></i>
            </div>
            <ul class="trash-items" id="trash-items"></ul>
          </div>
        </div>
      </div>
      <!-- Community Playlists -->
      <div class="community-section" id="community-section">
        <div class="community-header" id="community-header">
          <h2><i class="fas fa-globe"></i> Community Playlists</h2>
          <button class="toggle-btn" id="community-toggle"><i class="fas fa-chevron-down"></i></button>
        </div>
        <div class="community-body hidden" id="community-body">
          <div class="community-share-form" id="community-share-form" style="display:none;">
            <input type="text" id="community-share-name" placeholder="Share current playlist as...">
            <button id="community-share-btn"><i class="fas fa-share"></i> Share</button>
          </div>
          <ul class="community-list" id="community-list">
            <li class="community-empty">Loading community playlists...</li>
          </ul>
        </div>
      </div>
    </div>
    <!-- Confirmation Modal -->
    <div class="confirm-modal-overlay" id="confirm-modal">
      <div class="confirm-modal">
        <h3>Delete Playlist?</h3>
        <p id="confirm-modal-msg">Are you sure you want to delete this playlist? It will be moved to trash for 30 days.</p>
        <div class="confirm-modal-actions">
          <button class="confirm-cancel" id="confirm-cancel-btn">Cancel</button>
          <button class="confirm-delete" id="confirm-delete-btn">Delete</button>
        </div>
      </div>
    </div>
    <!-- Auth Modal -->
    <div class="auth-modal-overlay" id="auth-modal">
      <div class="auth-modal">
        <h2 id="auth-modal-title">Log In</h2>
        <p class="auth-subtitle" id="auth-modal-subtitle">Sign in to save favorites & share playlists</p>
        <div class="auth-error" id="auth-error"></div>
        <div id="auth-signup-fields" style="display:none;">
          <input type="text" id="auth-username" placeholder="Username" autocomplete="username">
        </div>
        <input type="email" id="auth-email" placeholder="Email" autocomplete="email">
        <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
        <button class="auth-btn" id="auth-submit-btn">Log In</button>
        <div class="auth-toggle">
          <span id="auth-toggle-text">Don't have an account?</span>
          <a id="auth-toggle-link">Sign Up</a>
        </div>
      </div>
    </div>
    <!-- Right side - Track Library -->
    <div class="library-container">
      <div class="library-wrapper">
        <div class="library-header" id="music-library-header">
          <h2><i class="fas fa-guitar"></i> Music Library</h2>
          <button class="toggle-btn" id="music-library-toggle"><i class="fas fa-chevron-up"></i></button>
        </div>
        <div class="library-body">
          <div class="instructions">
            <i class="fas fa-info-circle"></i>
            <span>Click a category to expand it. Drag categories by the grip icon to reorder. <strong>Shortcuts:</strong> Space = play/pause, Ctrl+Arrow = prev/next.</span>
          </div>
          <div class="library-search">
            <i class="fas fa-search"></i>
            <input type="text" id="library-search" placeholder="Search tracks by name, category...">
            <button class="search-clear" id="search-clear" title="Clear search"><i class="fas fa-times"></i></button>
          </div>
          <div class="search-stats" id="search-stats"></div>
          <div class="library-grid" id="library">
            <!-- Categories will be populated by JavaScript -->
          </div>
        </div>
      </div>
      <!-- Video Library -->
      <div class="video-library-wrapper" id="video-library-wrapper">
        <div class="video-library-header" id="video-library-header">
          <h2><i class="fas fa-film"></i> Video Library</h2>
          <button class="toggle-btn" id="video-library-toggle"><i class="fas fa-chevron-down"></i></button>
        </div>
        <div class="video-library-body hidden" id="video-library-body">
          <div class="video-view-toggle">
            <button class="video-view-btn active" data-view="horizontal"><i class="fas fa-th"></i> Horizontal</button>
            <button class="video-view-btn" data-view="vertical"><i class="fas fa-grip-vertical"></i> Vertical</button>
          </div>
          <div class="video-grid horizontal" id="video-grid">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Ambiance / Detached video overlay -->
  <div class="video-ambiance-overlay" id="video-ambiance-overlay">
    <video id="ambiance-video-detached" muted playsinline></video>
    <div class="video-ambiance-controls">
      <button id="ambiance-prev-btn" title="Previous"><i class="fas fa-step-backward"></i></button>
      <button id="ambiance-playpause-btn" title="Play/Pause"><i class="fas fa-pause"></i></button>
      <button id="ambiance-next-btn" title="Next"><i class="fas fa-step-forward"></i></button>
      <button id="ambiance-fullscreen-btn" title="Fullscreen"><i class="fas fa-expand"></i></button>
      <button id="ambiance-close-btn" title="Exit ambiance"><i class="fas fa-times"></i></button>
    </div>
  </div>
  <footer>
    <p>AudioOasis &copy; <span id="footer-year"></span> | Free studio-quality background music for work &amp; focus</p>
  </footer>
  
  <!-- Load external track data FIRST -->
  <script src="trackList.js"></script>
  <script src="videoList.js"></script>
  
  <!-- Main application script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // DOM Elements
      const audioPlayer = document.getElementById('audio-player');
      const playBtn = document.getElementById('play-btn');
      const nextBtn = document.getElementById('next-btn');
      const prevBtn = document.getElementById('prev-btn');
      const clearBtn = document.getElementById('clear-btn');
      const loopBtn = document.getElementById('loop-btn');

      const shuffleBtn = document.getElementById('shuffle-btn');
      const progressBar = document.getElementById('progress-bar');
      const volumeBar = document.getElementById('volume-bar');
      const currentTrackDisplay = document.getElementById('current-track');
      const currentCategoryDisplay = document.getElementById('current-category');
      const currentTimeDisplay = document.getElementById('current-time');
      const durationDisplay = document.getElementById('duration');
      const playlistItems = document.getElementById('playlist-items');
      const emptyPlaylist = document.getElementById('empty-playlist');
      const playlistCount = document.getElementById('playlist-count');
      const libraryElement = document.getElementById('library');
      // Tabs elements
      const singleTab = document.getElementById('single-tab');
      const mixerTab = document.getElementById('mixer-tab');
      const singlePlayerContent = document.getElementById('single-player-content');
      const mixerContent = document.getElementById('mixer-content');
      const mixerTracksContainer = document.getElementById('mixer-tracks');
      const emptyMixer = document.getElementById('empty-mixer');
      // Toggle elements
      const playlistHeader = document.getElementById('playlist-header');
      const playlistContent = document.getElementById('playlist-content');
      const playlistToggle = document.getElementById('playlist-toggle');
      const playlistElement = document.getElementById('playlist');
      const playlistNameInput = document.getElementById('playlist-name-input');
      const savePlaylistBtn = document.getElementById('save-playlist-btn');
      const saveDropdownToggle = document.getElementById('save-dropdown-toggle');
      const saveDropdownMenu = document.getElementById('save-dropdown-menu');
      const savedPlaylistsList = document.getElementById('saved-playlists-list');
      const savedPlaylistEditing = document.getElementById('saved-playlist-editing');
      const editingPlaylistNameDisplay = document.getElementById('editing-playlist-name');
      const doneEditBtn = document.getElementById('done-edit-btn');
      // New elements
      const darkModeToggle = document.getElementById('dark-mode-toggle');
      const librarySearchInput = document.getElementById('library-search');
      const searchClearBtn = document.getElementById('search-clear');
      const searchStats = document.getElementById('search-stats');
      const mixerMasterControls = document.getElementById('mixer-master-controls');
      const mixerPlayAll = document.getElementById('mixer-play-all');
      const mixerPauseAll = document.getElementById('mixer-pause-all');
      const mixerStopAll = document.getElementById('mixer-stop-all');
      const footerYear = document.getElementById('footer-year');

      // Set dynamic footer year
      footerYear.textContent = new Date().getFullYear();

      // ══════ API Client & Auth ══════
      const API_URL = 'https://audiooasis-api.dr-hunter.workers.dev';
      let authToken = localStorage.getItem('audiooasis.authToken') || null;
      let currentUser = null;
      let userFavorites = new Set(); // Set of track src strings for fast lookup

      // API helper
      async function api(path, options = {}) {
        const headers = { 'Content-Type': 'application/json', ...options.headers };
        if (authToken) headers['Authorization'] = 'Bearer ' + authToken;
        const res = await fetch(API_URL + path, { ...options, headers });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'API error');
        return data;
      }

      // Auth UI elements
      const userBtn = document.getElementById('user-btn');
      const userDropdown = document.getElementById('user-dropdown');
      const authModal = document.getElementById('auth-modal');
      const authSubmitBtn = document.getElementById('auth-submit-btn');
      const authError = document.getElementById('auth-error');
      const authToggleLink = document.getElementById('auth-toggle-link');
      let authMode = 'login'; // 'login' | 'signup'

      function updateAuthUI() {
        if (currentUser) {
          userBtn.classList.add('logged-in');
          userBtn.innerHTML = '<i class="fas fa-user-check"></i>';
          userBtn.title = currentUser.username;
          document.getElementById('user-dropdown-name').textContent = currentUser.username;
          document.getElementById('user-dropdown-email').textContent = currentUser.email;
          document.getElementById('user-logout-btn').style.display = '';
          document.getElementById('user-favorites-btn').style.display = '';
          document.getElementById('user-history-btn').style.display = '';
          // Show community share form
          document.getElementById('community-share-form').style.display = '';
        } else {
          userBtn.classList.remove('logged-in');
          userBtn.innerHTML = '<i class="fas fa-user"></i>';
          userBtn.title = 'Log In';
          document.getElementById('user-dropdown-name').textContent = 'Guest';
          document.getElementById('user-dropdown-email').textContent = 'Log in to unlock features';
          document.getElementById('user-logout-btn').style.display = 'none';
          document.getElementById('user-favorites-btn').style.display = 'none';
          document.getElementById('user-history-btn').style.display = 'none';
          document.getElementById('community-share-form').style.display = 'none';
        }
      }

      // User button click — show dropdown or auth modal
      userBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (currentUser) {
          userDropdown.classList.toggle('show');
        } else {
          showAuthModal('login');
        }
      });
      // Close dropdown on outside click
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.user-dropdown') && !e.target.closest('.user-btn')) {
          userDropdown.classList.remove('show');
        }
      });

      // Auth modal controls
      function showAuthModal(mode) {
        authMode = mode;
        authError.classList.remove('show');
        document.getElementById('auth-email').value = '';
        document.getElementById('auth-password').value = '';
        document.getElementById('auth-username').value = '';
        if (mode === 'signup') {
          document.getElementById('auth-modal-title').textContent = 'Sign Up';
          document.getElementById('auth-modal-subtitle').textContent = 'Create an account to save favorites & share playlists';
          document.getElementById('auth-signup-fields').style.display = '';
          authSubmitBtn.textContent = 'Sign Up';
          document.getElementById('auth-toggle-text').textContent = 'Already have an account?';
          authToggleLink.textContent = 'Log In';
        } else {
          document.getElementById('auth-modal-title').textContent = 'Log In';
          document.getElementById('auth-modal-subtitle').textContent = 'Sign in to save favorites & share playlists';
          document.getElementById('auth-signup-fields').style.display = 'none';
          authSubmitBtn.textContent = 'Log In';
          document.getElementById('auth-toggle-text').textContent = "Don't have an account?";
          authToggleLink.textContent = 'Sign Up';
        }
        authModal.classList.add('show');
      }
      authToggleLink.addEventListener('click', () => showAuthModal(authMode === 'login' ? 'signup' : 'login'));
      authModal.addEventListener('click', (e) => { if (e.target === authModal) authModal.classList.remove('show'); });

      // Submit auth form
      authSubmitBtn.addEventListener('click', async function() {
        authError.classList.remove('show');
        authSubmitBtn.disabled = true;
        authSubmitBtn.textContent = authMode === 'login' ? 'Logging in...' : 'Signing up...';
        try {
          const email = document.getElementById('auth-email').value.trim();
          const password = document.getElementById('auth-password').value;
          if (authMode === 'signup') {
            const username = document.getElementById('auth-username').value.trim();
            const data = await api('/auth/signup', { method: 'POST', body: JSON.stringify({ email, username, password }) });
            authToken = data.token;
            currentUser = data.user;
          } else {
            const data = await api('/auth/login', { method: 'POST', body: JSON.stringify({ email, password }) });
            authToken = data.token;
            currentUser = data.user;
          }
          localStorage.setItem('audiooasis.authToken', authToken);
          authModal.classList.remove('show');
          updateAuthUI();
          loadFavorites();
        } catch (err) {
          authError.textContent = err.message;
          authError.classList.add('show');
        } finally {
          authSubmitBtn.disabled = false;
          authSubmitBtn.textContent = authMode === 'login' ? 'Log In' : 'Sign Up';
        }
      });

      // Enter key in auth fields
      document.getElementById('auth-password').addEventListener('keydown', (e) => { if (e.key === 'Enter') authSubmitBtn.click(); });

      // Logout
      document.getElementById('user-logout-btn').addEventListener('click', function() {
        authToken = null;
        currentUser = null;
        userFavorites.clear();
        localStorage.removeItem('audiooasis.authToken');
        userDropdown.classList.remove('show');
        updateAuthUI();
        updateFavoriteButtons();
      });

      // Try to restore session from token
      async function restoreSession() {
        if (!authToken) { updateAuthUI(); return; }
        try {
          const data = await api('/me');
          currentUser = data.user;
          updateAuthUI();
          loadFavorites();
        } catch {
          // Token expired or invalid
          authToken = null;
          localStorage.removeItem('audiooasis.authToken');
          updateAuthUI();
        }
      }

      // ══════ Favorites System ══════
      async function loadFavorites() {
        if (!authToken) return;
        try {
          const data = await api('/favorites');
          userFavorites.clear();
          data.favorites.forEach(f => userFavorites.add(f.track_src));
          updateFavoriteButtons();
        } catch (e) { console.warn('Failed to load favorites:', e); }
      }

      async function toggleFavorite(track) {
        if (!currentUser) { showAuthModal('login'); return; }
        const src = track.src;
        try {
          if (userFavorites.has(src)) {
            await api('/favorites', { method: 'DELETE', body: JSON.stringify({ track_src: src }) });
            userFavorites.delete(src);
          } else {
            await api('/favorites', { method: 'POST', body: JSON.stringify({ track_src: src, track_title: track.title, track_category: track.category || '' }) });
            userFavorites.add(src);
          }
          updateFavoriteButtons();
        } catch (e) { console.error('Favorite toggle failed:', e); }
      }

      function updateFavoriteButtons() {
        document.querySelectorAll('.fav-btn').forEach(btn => {
          const src = btn.dataset.src;
          if (userFavorites.has(src)) {
            btn.classList.add('hearted');
            btn.innerHTML = '<i class="fas fa-heart"></i>';
          } else {
            btn.classList.remove('hearted');
            btn.innerHTML = '<i class="far fa-heart"></i>';
          }
        });
      }

      // Favorites button in dropdown — scroll to and expand "Favorites" in library
      document.getElementById('user-favorites-btn').addEventListener('click', function() {
        userDropdown.classList.remove('show');
        // Filter library to show only favorites
        if (userFavorites.size === 0) {
          alert('You have no favorites yet! Click the heart icon on any track to add it.');
          return;
        }
        librarySearchInput.value = '♥'; // special search token
        searchClearBtn.classList.add('visible');
        filterLibrary('♥');
      });

      // History button
      document.getElementById('user-history-btn').addEventListener('click', async function() {
        userDropdown.classList.remove('show');
        if (!authToken) return;
        try {
          const data = await api('/history?limit=30');
          if (data.history.length === 0) { alert('No listening history yet.'); return; }
          // Load history tracks into playlist
          const historyTracks = data.history.map(h => ({
            title: h.track_title,
            src: h.track_src,
            category: h.track_category,
            duration: ''
          }));
          // Remove duplicates keeping most recent
          const seen = new Set();
          const unique = historyTracks.filter(t => { if (seen.has(t.src)) return false; seen.add(t.src); return true; });
          if (confirm('Load your ' + unique.length + ' most recent tracks into the playlist?')) {
            unique.forEach(t => addToPlaylist(t));
          }
        } catch (e) { console.error('History load failed:', e); }
      });

      // ══════ Community Playlists ══════
      const communityBody = document.getElementById('community-body');
      const communityToggle = document.getElementById('community-toggle');
      document.getElementById('community-header').addEventListener('click', function() {
        communityBody.classList.toggle('hidden');
        communityToggle.querySelector('i').className = communityBody.classList.contains('hidden') ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
        if (!communityBody.classList.contains('hidden')) loadCommunityPlaylists();
      });

      async function loadCommunityPlaylists() {
        const list = document.getElementById('community-list');
        list.innerHTML = '<li class="community-empty">Loading...</li>';
        try {
          const data = await api('/community/playlists?limit=20&sort=likes');
          if (data.playlists.length === 0) {
            list.innerHTML = '<li class="community-empty"><i class="fas fa-globe"></i><br>No community playlists yet. Be the first to share!</li>';
            return;
          }
          list.innerHTML = '';
          data.playlists.forEach(p => {
            const li = document.createElement('li');
            li.className = 'community-card';
            const liked = p.liked_by_me ? 'liked' : '';
            li.innerHTML = `
              <div class="community-card-top">
                <span class="community-card-name">${escapeHTML(p.name)}</span>
                <span class="community-card-meta">
                  <span><i class="fas fa-music"></i> ${p.track_count || 0}</span>
                  <span><i class="fas fa-heart"></i> ${p.total_likes}</span>
                  <span>by ${escapeHTML(p.creator_name)}</span>
                </span>
              </div>
              <div class="community-card-actions">
                <button class="community-like-btn ${liked}" data-id="${p.id}"><i class="fas fa-heart"></i> ${p.total_likes}</button>
                <button class="community-load-btn" data-id="${p.id}"><i class="fas fa-download"></i> Load</button>
              </div>
            `;
            li.querySelector('.community-like-btn').addEventListener('click', async function() {
              if (!currentUser) { showAuthModal('login'); return; }
              try {
                const res = await api('/community/playlists/' + p.id + '/like', { method: 'POST' });
                this.classList.toggle('liked', res.liked);
                p.total_likes += res.liked ? 1 : -1;
                this.innerHTML = '<i class="fas fa-heart"></i> ' + p.total_likes;
              } catch (e) { console.error('Like failed:', e); }
            });
            li.querySelector('.community-load-btn').addEventListener('click', async function() {
              try {
                const detail = await api('/community/playlists/' + p.id);
                const cp = detail.playlist;
                if (cp.tracks && cp.tracks.length > 0) {
                  cp.tracks.forEach(t => addToPlaylist({ title: t.track_title, src: t.track_src, category: t.track_category || '', duration: '' }));
                }
                if (cp.videos && cp.videos.length > 0) {
                  // Add videos to video playlist if the function exists
                  cp.videos.forEach(v => {
                    if (typeof addVideoToPlaylist === 'function') addVideoToPlaylist({ title: v.video_title, src: v.video_src });
                  });
                }
                this.innerHTML = '<i class="fas fa-check"></i> Loaded!';
                setTimeout(() => { this.innerHTML = '<i class="fas fa-download"></i> Load'; }, 1500);
              } catch (e) { console.error('Load failed:', e); }
            });
            list.appendChild(li);
          });
        } catch (e) {
          list.innerHTML = '<li class="community-empty">Failed to load playlists. Try again later.</li>';
          console.error('Community load failed:', e);
        }
      }

      // Share current playlist to community
      document.getElementById('community-share-btn').addEventListener('click', async function() {
        const nameInput = document.getElementById('community-share-name');
        const name = nameInput.value.trim();
        if (!name) { nameInput.focus(); return; }
        if (!currentUser) { showAuthModal('login'); return; }
        try {
          const tracks = playlist.map(t => ({ src: t.src, title: t.title, category: t.category || '' }));
          // Get video playlist items if any
          const videoItems = Array.from(document.querySelectorAll('#video-playlist-items li')).map(li => ({
            src: li.dataset.src || '',
            title: li.querySelector('.video-playlist-title')?.textContent || ''
          })).filter(v => v.src);
          await api('/community/playlists', { method: 'POST', body: JSON.stringify({ name, tracks, videos: videoItems }) });
          nameInput.value = '';
          this.innerHTML = '<i class="fas fa-check"></i> Shared!';
          setTimeout(() => { this.innerHTML = '<i class="fas fa-share"></i> Share'; }, 2000);
          loadCommunityPlaylists();
        } catch (e) {
          alert('Failed to share: ' + e.message);
        }
      });

      function escapeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      // ══════ Listen History ══════
      let lastHistoryTrack = null;
      function recordListenHistory(track) {
        if (!authToken || !track) return;
        // Throttle: don't record the same track twice in a row
        if (lastHistoryTrack === track.src) return;
        lastHistoryTrack = track.src;
        // Fire and forget
        api('/history', { method: 'POST', body: JSON.stringify({ track_src: track.src, track_title: track.title, track_category: track.category || '' }) }).catch(() => {});
      }

      // Initialize auth on page load
      restoreSession();

      // Genre icon mapping
      const genreIcons = {
        'ES LoFi': 'fa-headphones-alt',
        'AL LoFi': 'fa-headphones-alt',
        'LoFi': 'fa-coffee',
        'Background Music': 'fa-cloud',
        'Coding Mix': 'fa-code',
        'Meditation': 'fa-spa',
        'Dark': 'fa-moon',
        'Classical': 'fa-music',
        'Choir': 'fa-church',
        'Fantasy': 'fa-hat-wizard',
        'Vocals': 'fa-microphone-alt',
        'Piano': 'fa-piano',
        'Violin and Cello': 'fa-violin',
        'Orchestra': 'fa-theater-masks',
        'Percussion': 'fa-drum',
        'Flutes': 'fa-wind',
        'Japanese': 'fa-torii-gate',
        'Accordion': 'fa-accordion',
        'Oregon': 'fa-mountain',
        'Arabic': 'fa-mosque',
        'Background Ambiance': 'fa-leaf',
        'Loops': 'fa-sync-alt'
      };
      // Player state
      let currentTrackIndex = -1;
      let isPlaying = false;
      let isLooping = false;
      let playlist = [];
      let mixerTracks = [];
      let savedPlaylists = {};
      let editingPlaylistName = null;
      let currentSaveType = 'all'; // 'all', 'music', 'video'
      
      // Note: trackLibrary is now loaded from trackList.js
      // Check if trackLibrary exists
      if (typeof trackLibrary === 'undefined') {
        console.error('trackLibrary not found. Make sure trackList.js is loaded.');
        trackLibrary = {}; // Fallback to empty object
      }

      const storedPlaylists = localStorage.getItem('audiooasis.savedPlaylists');
      if (storedPlaylists) {
        try {
          const parsed = JSON.parse(storedPlaylists);
          // Migrate old format: if value is an array, convert to new {type, tracks, videos} format
          for (const [name, data] of Object.entries(parsed)) {
            if (Array.isArray(data)) {
              parsed[name] = { type: 'music', tracks: data, videos: [] };
            }
          }
          savedPlaylists = parsed;
        } catch (error) {
          console.warn('Saved playlists data was invalid. Resetting storage.', error);
          savedPlaylists = {};
          localStorage.removeItem('audiooasis.savedPlaylists');
        }
      }

      function savePlaylistsToStorage() {
        localStorage.setItem('audiooasis.savedPlaylists', JSON.stringify(savedPlaylists));
      }

      // ── Trash System ──
      let trashedPlaylists = [];
      const TRASH_KEY = 'audiooasis.trashedPlaylists';
      const TRASH_DAYS = 30;

      (function loadTrash() {
        try {
          const raw = localStorage.getItem(TRASH_KEY);
          if (raw) trashedPlaylists = JSON.parse(raw);
        } catch (e) { trashedPlaylists = []; }
        purgeOldTrash();
      })();

      function saveTrashToStorage() {
        localStorage.setItem(TRASH_KEY, JSON.stringify(trashedPlaylists));
      }

      function purgeOldTrash() {
        const now = Date.now();
        const cutoff = TRASH_DAYS * 24 * 60 * 60 * 1000;
        trashedPlaylists = trashedPlaylists.filter(t => now - t.deletedAt < cutoff);
        saveTrashToStorage();
      }

      function trashPlaylist(name) {
        const data = savedPlaylists[name];
        if (!data) return;
        trashedPlaylists.push({ name, data, deletedAt: Date.now() });
        delete savedPlaylists[name];
        if (editingPlaylistName === name) {
          editingPlaylistName = null;
          document.getElementById('saved-playlist-editing').classList.add('hidden');
        }
        savePlaylistsToStorage();
        saveTrashToStorage();
        renderSavedPlaylists();
        renderTrash();
      }

      function restoreFromTrash(index) {
        const item = trashedPlaylists[index];
        if (!item) return;
        // If a playlist with the same name exists, append a number
        let restoreName = item.name;
        let counter = 1;
        while (savedPlaylists[restoreName]) {
          restoreName = item.name + ' (' + counter + ')';
          counter++;
        }
        savedPlaylists[restoreName] = item.data;
        trashedPlaylists.splice(index, 1);
        savePlaylistsToStorage();
        saveTrashToStorage();
        renderSavedPlaylists();
        renderTrash();
      }

      function permanentlyDelete(index) {
        trashedPlaylists.splice(index, 1);
        saveTrashToStorage();
        renderTrash();
      }

      function renderTrash() {
        const section = document.getElementById('trash-section');
        const list = document.getElementById('trash-items');
        if (trashedPlaylists.length === 0) {
          section.style.display = 'none';
          return;
        }
        section.style.display = 'block';
        list.innerHTML = '';
        trashedPlaylists.forEach((item, idx) => {
          const daysLeft = Math.max(0, Math.ceil((TRASH_DAYS * 86400000 - (Date.now() - item.deletedAt)) / 86400000));
          const li = document.createElement('li');
          li.className = 'trash-item';
          li.innerHTML = `
            <div class="trash-item-details">
              <span class="trash-item-name">${item.name}</span>
              <span class="trash-item-meta">${daysLeft} day${daysLeft !== 1 ? 's' : ''} left</span>
            </div>
            <div class="trash-item-actions">
              <button class="restore-btn" title="Restore"><i class="fas fa-undo"></i></button>
              <button class="perm-delete-btn" title="Delete permanently"><i class="fas fa-times"></i></button>
            </div>`;
          li.querySelector('.restore-btn').addEventListener('click', () => restoreFromTrash(idx));
          li.querySelector('.perm-delete-btn').addEventListener('click', () => permanentlyDelete(idx));
          list.appendChild(li);
        });
      }

      // Confirmation modal
      let pendingDeleteName = null;
      function showDeleteConfirm(name) {
        pendingDeleteName = name;
        document.getElementById('confirm-modal-msg').textContent =
          'Are you sure you want to delete "' + name + '"? It will be moved to trash for 30 days.';
        document.getElementById('confirm-modal').classList.add('show');
      }
      document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
        document.getElementById('confirm-modal').classList.remove('show');
        pendingDeleteName = null;
      });
      document.getElementById('confirm-delete-btn').addEventListener('click', () => {
        if (pendingDeleteName) trashPlaylist(pendingDeleteName);
        document.getElementById('confirm-modal').classList.remove('show');
        pendingDeleteName = null;
      });
      document.getElementById('confirm-modal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          e.currentTarget.classList.remove('show');
          pendingDeleteName = null;
        }
      });

      // Trash section toggle
      document.getElementById('trash-header').addEventListener('click', () => {
        const items = document.getElementById('trash-items');
        const chevron = document.getElementById('trash-chevron');
        items.classList.toggle('show');
        chevron.classList.toggle('fa-chevron-down');
        chevron.classList.toggle('fa-chevron-up');
      });

      function syncEditingPlaylist() {
        if (!editingPlaylistName) return;
        const entry = savedPlaylists[editingPlaylistName];
        const saveType = entry ? entry.type : 'all';
        if (saveType === 'music') {
          savedPlaylists[editingPlaylistName] = { type: 'music', tracks: playlist.map(t => ({...t})), videos: [] };
        } else if (saveType === 'video') {
          savedPlaylists[editingPlaylistName] = { type: 'video', tracks: [], videos: (typeof videoPlaylist !== 'undefined' ? videoPlaylist : []).map(v => ({...v})) };
        } else {
          savedPlaylists[editingPlaylistName] = { type: 'all', tracks: playlist.map(t => ({...t})), videos: (typeof videoPlaylist !== 'undefined' ? videoPlaylist : []).map(v => ({...v})) };
        }
        savePlaylistsToStorage();
        renderSavedPlaylists();
      }

      function setEditingPlaylist(name) {
        editingPlaylistName = name;
        if (name) {
          savedPlaylistEditing.classList.remove('hidden');
          editingPlaylistNameDisplay.textContent = name;
          savePlaylistBtn.textContent = 'Update';
          playlistNameInput.value = name;
          return;
        }
        savedPlaylistEditing.classList.add('hidden');
        editingPlaylistNameDisplay.textContent = '';
        savePlaylistBtn.textContent = 'Save All';
        playlistNameInput.value = '';
      }

      function loadPlaylistTracks(tracks) {
        playlist = tracks.map(track => ({ ...track }));
        if (playlist.length === 0) {
          currentTrackIndex = -1;
          audioPlayer.src = '';
          currentTrackDisplay.textContent = 'No Track Selected';
          currentCategoryDisplay.textContent = '';
          currentTimeDisplay.textContent = '0:00';
          durationDisplay.textContent = '0:00';
          progressBar.value = 0;
          pauseTrack();
          updatePlaylistDisplay();
          return;
        }
        currentTrackIndex = 0;
        updatePlaylistDisplay();
        loadTrack(0);
      }

      var loadPlaylistVideos = function(videos) {
        // Video system not ready yet — store for deferred loading
        window._pendingVideoLoad = videos;
      };

      // Get saved category order from localStorage
      function getSavedCategoryOrder() {
        try {
          const saved = localStorage.getItem('audiooasis.categoryOrder');
          return saved ? JSON.parse(saved) : null;
        } catch(e) { return null; }
      }
      function saveCategoryOrder() {
        const order = Array.from(libraryElement.querySelectorAll('.category')).map(el => el.dataset.categoryKey);
        localStorage.setItem('audiooasis.categoryOrder', JSON.stringify(order));
      }

      // ══════ Virtual Scrolling System ══════
      const TRACK_HEIGHT = 48; // estimated px per track row
      const BUFFER_TRACKS = 5; // extra tracks above/below viewport
      // Map to store virtual scroll state per category
      const categoryVScrollState = new Map();

      function createTrackElement(track, category, index) {
        const el = document.createElement('div');
        el.className = 'category-track';
        el.dataset.src = track.src;
        el.dataset.title = track.title;
        el.dataset.duration = track.duration;
        el.dataset.search = track.title.toLowerCase() + ' ' + category.toLowerCase();
        el.dataset.trackIndex = index;
        el.innerHTML = `
          <span>${track.title}</span>
          <div class="track-actions">
            <button class="fav-btn" data-src="${track.src}" title="Favorite"><i class="${userFavorites.has(track.src) ? 'fas' : 'far'} fa-heart"></i></button>
            <button class="add-to-playlist-btn" title="Add to playlist"><i class="fas fa-play-circle"></i></button>
            <button class="add-to-mixer-btn" title="Add to mixer"><i class="fas fa-sliders-h"></i></button>
            <span class="track-duration">${track.duration}</span>
          </div>
        `;
        // Heart/favorite button
        el.querySelector('.fav-btn').addEventListener('click', function(e) {
          e.stopPropagation();
          toggleFavorite(track);
        });
        // Attach event listeners
        el.querySelector('.add-to-playlist-btn').addEventListener('click', function(e) {
          e.stopPropagation();
          addToPlaylist(track);
          this.innerHTML = '<i class="fas fa-check"></i>';
          this.style.backgroundColor = '#2ecc71';
          setTimeout(() => {
            this.innerHTML = '<i class="fas fa-play-circle"></i>';
            this.style.backgroundColor = '';
          }, 1000);
        });
        el.querySelector('.add-to-mixer-btn').addEventListener('click', function(e) {
          e.stopPropagation();
          addToMixer(track);
          this.innerHTML = '<i class="fas fa-check"></i>';
          this.style.backgroundColor = '#2ecc71';
          setTimeout(() => {
            this.innerHTML = '<i class="fas fa-sliders-h"></i>';
            this.style.backgroundColor = '';
          }, 1000);
        });
        // Mobile: first tap highlights track & shows buttons, second tap on button acts
        el.addEventListener('click', function(e) {
          // Only on touch devices (no hover capability)
          if (!window.matchMedia('(hover: none)').matches) return;
          // If clicking a button inside the track, let it through
          if (e.target.closest('.add-to-playlist-btn') || e.target.closest('.add-to-mixer-btn') || e.target.closest('.fav-btn')) return;
          e.stopPropagation();
          // Clear any other active track
          document.querySelectorAll('.category-track.mobile-active').forEach(t => {
            if (t !== el) t.classList.remove('mobile-active');
          });
          el.classList.toggle('mobile-active');
        });
        return el;
      }

      // Dismiss mobile-active when tapping outside a track
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.category-track')) {
          document.querySelectorAll('.category-track.mobile-active').forEach(t => t.classList.remove('mobile-active'));
        }
      });

      function renderVirtualTracks(categoryElement) {
        const state = categoryVScrollState.get(categoryElement);
        if (!state) return;

        const contentEl = categoryElement.querySelector('.category-content');
        const tracksContainer = categoryElement.querySelector('.category-tracks');
        const spacer = tracksContainer.querySelector('.category-tracks-spacer');
        const scrollTop = contentEl.scrollTop;

        // Determine which tracks are visible (filter-aware)
        const visibleTracks = state.filteredIndices || state.allIndices;
        const totalHeight = visibleTracks.length * TRACK_HEIGHT;
        spacer.style.height = totalHeight + 'px';

        const startIdx = Math.max(0, Math.floor(scrollTop / TRACK_HEIGHT) - BUFFER_TRACKS);
        const viewportHeight = contentEl.clientHeight || 400;
        const endIdx = Math.min(visibleTracks.length, Math.ceil((scrollTop + viewportHeight) / TRACK_HEIGHT) + BUFFER_TRACKS);

        // Check if we need to re-render (range changed)
        if (state.renderedStart === startIdx && state.renderedEnd === endIdx) return;
        state.renderedStart = startIdx;
        state.renderedEnd = endIdx;

        // Remove old rendered tracks (keep spacer)
        const oldTracks = tracksContainer.querySelectorAll('.category-track');
        oldTracks.forEach(el => el.remove());

        // Create a document fragment for batch DOM insert
        const fragment = document.createDocumentFragment();
        for (let i = startIdx; i < endIdx; i++) {
          const trackIdx = visibleTracks[i];
          const track = state.tracks[trackIdx];
          const el = createTrackElement(track, state.categoryName, trackIdx);
          el.style.position = 'absolute';
          el.style.top = (i * TRACK_HEIGHT) + 'px';
          el.style.left = '0';
          el.style.right = '0';
          // If filtered out, hide it
          if (state.hiddenIndices && state.hiddenIndices.has(trackIdx)) {
            el.classList.add('search-hidden');
          }
          fragment.appendChild(el);
        }
        tracksContainer.appendChild(fragment);
      }

      // Initialize the library
      function initializeLibrary() {
        libraryElement.innerHTML = '';

        // Determine category order
        const savedOrder = getSavedCategoryOrder();
        let categoryEntries = Object.entries(trackLibrary);
        if (savedOrder && savedOrder.length > 0) {
          categoryEntries.sort((a, b) => {
            const idxA = savedOrder.indexOf(a[0]);
            const idxB = savedOrder.indexOf(b[0]);
            if (idxA === -1 && idxB === -1) return 0;
            if (idxA === -1) return 1;
            if (idxB === -1) return -1;
            return idxA - idxB;
          });
        }

        for (const [category, tracks] of categoryEntries) {
          const categoryElement = document.createElement('div');
          categoryElement.className = 'category';
          categoryElement.dataset.category = category.toLowerCase();
          categoryElement.dataset.categoryKey = category;
          categoryElement.setAttribute('draggable', 'true');
          const iconClass = genreIcons[category] || 'fa-folder';

          // Build only header + empty virtual container (no track HTML yet)
          categoryElement.innerHTML = `
            <div class="category-header">
              <div class="category-header-left">
                <span class="category-drag-handle" title="Drag to reorder"><i class="fas fa-grip-vertical"></i></span>
                <h3><i class="fas ${iconClass}"></i> ${category} <span class="track-count">(${tracks.length} tracks)</span></h3>
              </div>
              <div class="category-header-right">
                <button class="add-all-btn" title="Add all tracks to playlist"><i class="fas fa-plus-circle"></i> All</button>
                <button class="toggle-btn category-toggle">
                  <i class="fas fa-chevron-down"></i>
                </button>
              </div>
            </div>
            <div class="category-content">
              <div class="category-tracks">
                <div class="category-tracks-spacer"></div>
              </div>
            </div>
          `;
          libraryElement.appendChild(categoryElement);

          // Store virtual scroll state
          const allIndices = tracks.map((_, i) => i);
          categoryVScrollState.set(categoryElement, {
            categoryName: category,
            tracks: tracks,
            allIndices: allIndices,
            filteredIndices: null,
            hiddenIndices: null,
            renderedStart: -1,
            renderedEnd: -1
          });

          // Scroll handler for virtual rendering
          const contentEl = categoryElement.querySelector('.category-content');
          contentEl.addEventListener('scroll', () => renderVirtualTracks(categoryElement));

          // Add All button handler
          const addAllBtn = categoryElement.querySelector('.add-all-btn');
          addAllBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            tracks.forEach(track => addToPlaylist(track));
            this.innerHTML = '<i class="fas fa-check-circle"></i> Added!';
            this.style.background = 'rgba(46,204,113,0.5)';
            setTimeout(() => {
              this.innerHTML = '<i class="fas fa-plus-circle"></i> All';
              this.style.background = '';
            }, 1500);
          });

          // Toggle expand/collapse
          const header = categoryElement.querySelector('.category-header');
          const toggleBtn = categoryElement.querySelector('.category-toggle');
          header.addEventListener('click', function(e) {
            if (e.target.closest('.add-all-btn') || e.target.closest('.category-drag-handle')) return;
            categoryElement.classList.toggle('expanded');
            toggleBtn.querySelector('i').className = categoryElement.classList.contains('expanded')
              ? 'fas fa-chevron-up'
              : 'fas fa-chevron-down';
            // Render virtual tracks when expanding
            if (categoryElement.classList.contains('expanded')) {
              // Reset render state so it re-renders
              const state = categoryVScrollState.get(categoryElement);
              if (state) { state.renderedStart = -1; state.renderedEnd = -1; }
              requestAnimationFrame(() => renderVirtualTracks(categoryElement));
            }
          });

          // ── Category Drag & Drop ──
          categoryElement.addEventListener('dragstart', function(e) {
            // Only start drag from the grip handle
            if (!e.target.closest('.category-drag-handle') && !e.target.closest('.category-header')) {
              e.preventDefault();
              return;
            }
            categoryElement.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', category);
          });
          categoryElement.addEventListener('dragend', function() {
            categoryElement.classList.remove('dragging');
            libraryElement.querySelectorAll('.category').forEach(c => c.classList.remove('drag-over'));
          });
          categoryElement.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const dragging = libraryElement.querySelector('.category.dragging');
            if (dragging && dragging !== categoryElement) {
              categoryElement.classList.add('drag-over');
            }
          });
          categoryElement.addEventListener('dragleave', function() {
            categoryElement.classList.remove('drag-over');
          });
          categoryElement.addEventListener('drop', function(e) {
            e.preventDefault();
            categoryElement.classList.remove('drag-over');
            const dragging = libraryElement.querySelector('.category.dragging');
            if (dragging && dragging !== categoryElement) {
              const allCats = Array.from(libraryElement.querySelectorAll('.category'));
              const fromIdx = allCats.indexOf(dragging);
              const toIdx = allCats.indexOf(categoryElement);
              if (fromIdx < toIdx) {
                categoryElement.after(dragging);
              } else {
                categoryElement.before(dragging);
              }
              saveCategoryOrder();
            }
          });
        }
      }
      // Tab switching
      singleTab.addEventListener('click', function() {
        singleTab.classList.add('active');
        mixerTab.classList.remove('active');
        singlePlayerContent.classList.add('active');
        mixerContent.classList.remove('active');
      });
      mixerTab.addEventListener('click', function() {
        mixerTab.classList.add('active');
        singleTab.classList.remove('active');
        mixerContent.classList.add('active');
        singlePlayerContent.classList.remove('active');
        // Single player continues playing when switching to mixer
      });
      // Playlist toggle - default to open (no collapsed class)
      playlistHeader.addEventListener('click', function() {
        playlistElement.classList.toggle('collapsed');
        playlistToggle.querySelector('i').className = playlistElement.classList.contains('collapsed')
          ? 'fas fa-chevron-down'
          : 'fas fa-chevron-up';
      });
      // Saved playlists toggle
      const savedPlaylistsHeader = document.getElementById('saved-playlists-header');
      const savedPlaylistsElement = document.getElementById('saved-playlists');
      const savedPlaylistsToggle = document.getElementById('saved-playlists-toggle');
      savedPlaylistsHeader.addEventListener('click', function() {
        savedPlaylistsElement.classList.toggle('collapsed');
        savedPlaylistsToggle.querySelector('i').className = savedPlaylistsElement.classList.contains('collapsed')
          ? 'fas fa-chevron-down'
          : 'fas fa-chevron-up';
      });
      // Add track to mixer
      function addToMixer(track) {
        // Check if track is already in mixer
        if (mixerTracks.some(t => t.src === track.src)) {
          // Find and remove existing track
          const existingIndex = mixerTracks.findIndex(t => t.src === track.src);
          removeFromMixer(existingIndex);
          return;
        }
        const mixerTrack = {
          ...track,
          audio: new Audio(track.src),
          isPlaying: false,
          volume: 0.5,
          id: Date.now() + Math.random()
        };
        mixerTracks.push(mixerTrack);
        updateMixerDisplay();
        // Switch to mixer tab if not already there
        if (!mixerTab.classList.contains('active')) {
          mixerTab.click();
        }
      }
      // Remove track from mixer
      function removeFromMixer(index) {
        if (index < 0 || index >= mixerTracks.length) return;
        // Stop and clean up audio
        const track = mixerTracks[index];
        track.audio.pause();
        track.audio.src = '';
        mixerTracks.splice(index, 1);
        updateMixerDisplay();
      }
      // Update mixer display
      function updateMixerDisplay() {
        if (mixerTracks.length === 0) {
          emptyMixer.classList.remove('hidden');
          mixerMasterControls.classList.add('hidden');
          return;
        }
        emptyMixer.classList.add('hidden');
        mixerMasterControls.classList.remove('hidden');
        // Create mixer tracks HTML
        let mixerHTML = '';
        mixerTracks.forEach((track, index) => {
          mixerHTML += `
            <div class="mixer-track" data-id="${track.id}">
              <div class="mixer-track-header">
                <div class="mixer-track-title">
                  <i class="fas fa-music"></i>
                  <span>${track.title}</span>
                </div>
                <div class="mixer-track-controls">
                  <button class="mixer-control-btn ${track.isPlaying ? 'active' : ''}" data-action="play-pause" title="${track.isPlaying ? 'Pause' : 'Play'}">
                    <i class="fas fa-${track.isPlaying ? 'pause' : 'play'}"></i>
                  </button>
                  <button class="mixer-control-btn" data-action="remove" title="Remove from mixer">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
              <div class="mixer-volume-control">
                <i class="fas fa-volume-down" style="color: #9b59b6;"></i>
                <input type="range" class="mixer-volume-slider" min="0" max="100" value="${track.volume * 100}">
                <span class="mixer-volume-value">${Math.round(track.volume * 100)}%</span>
              </div>
              <!-- Progress bar for mixer track -->
              <div class="mixer-progress-container">
                <input type="range" class="mixer-progress-bar" value="0" max="100">
                <div class="mixer-time-display">
                  <span class="mixer-current-time">0:00</span>
                  <span class="mixer-duration">${track.duration || '0:00'}</span>
                </div>
              </div>
            </div>
          `;
        });
        mixerTracksContainer.innerHTML = mixerHTML;
        // Add event listeners to mixer controls
        mixerTracksContainer.querySelectorAll('.mixer-track').forEach((element, index) => {
          const track = mixerTracks[index];
          // Play/pause button
          const playBtn = element.querySelector('[data-action="play-pause"]');
          playBtn.addEventListener('click', function() {
            if (track.isPlaying) {
              track.audio.pause();
              track.isPlaying = false;
              this.classList.remove('active');
              this.innerHTML = '<i class="fas fa-play"></i>';
            } else {
              track.audio.play().catch(error => {
                console.error("Mixer playback failed:", error);
              });
              track.isPlaying = true;
              this.classList.add('active');
              this.innerHTML = '<i class="fas fa-pause"></i>';
            }
          });
          // Remove button
          const removeBtn = element.querySelector('[data-action="remove"]');
          removeBtn.addEventListener('click', function() {
            removeFromMixer(index);
          });
          // Volume slider
          const volumeSlider = element.querySelector('.mixer-volume-slider');
          const volumeValue = element.querySelector('.mixer-volume-value');
          volumeSlider.addEventListener('input', function() {
            const volume = this.value / 100;
            track.volume = volume;
            track.audio.volume = volume;
            volumeValue.textContent = `${this.value}%`;
          });
          // Progress bar elements
          const progressBar = element.querySelector('.mixer-progress-bar');
          const currentTimeDisplay = element.querySelector('.mixer-current-time');
          const durationDisplay = element.querySelector('.mixer-duration');
          // Set initial duration if available
          if (track.duration && track.duration !== '0:00') {
            durationDisplay.textContent = track.duration;
          }
          // Update progress as audio plays
          track.audio.addEventListener('timeupdate', function() {
            if (!isNaN(track.audio.duration)) {
              const progress = (track.audio.currentTime / track.audio.duration) * 100;
              progressBar.value = isNaN(progress) ? 0 : progress;
              currentTimeDisplay.textContent = formatTime(track.audio.currentTime);
            }
          });
          // Allow seeking in mixer track
          progressBar.addEventListener('input', function() {
            if (!isNaN(track.audio.duration)) {
              const time = (this.value / 100) * track.audio.duration;
              track.audio.currentTime = time;
            }
          });
          // Set initial volume
          track.audio.volume = track.volume;
          // Loop the audio
          track.audio.loop = true;
          // Handle audio errors
          track.audio.addEventListener('error', function() {
            console.error("Failed to load track:", track.title);
            playBtn.disabled = true;
            playBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
          });
          // Loop track when it ends
          track.audio.addEventListener('ended', function() {
            track.audio.currentTime = 0;
            if (track.isPlaying) {
              track.audio.play();
            }
          });
        });
      }
      // Add track to playlist
      function addToPlaylist(track) {
        playlist.push(track);
        updatePlaylistDisplay();
        // If this is the first track added, play it
        if (playlist.length === 1) {
          currentTrackIndex = 0;
          loadTrack(currentTrackIndex);
        }
      }
      // Update playlist display
      function updatePlaylistDisplay() {
        playlistCount.textContent = `${playlist.length} track${playlist.length !== 1 ? 's' : ''} in playlist`;
        if (playlist.length === 0) {
          emptyPlaylist.classList.remove('hidden');
          playlistItems.innerHTML = '';
          syncEditingPlaylist();
          return;
        }
      emptyPlaylist.classList.add('hidden');
      playlistItems.innerHTML = '';
        playlist.forEach((track, index) => {
          const item = document.createElement('li');
          item.className = `playlist-item ${index === currentTrackIndex ? 'active' : ''}`;
          item.setAttribute('draggable', 'true');
          item.dataset.index = index;
          item.innerHTML = `
          <div class="track-index">${index + 1}</div>
          <div class="track-details">
              <div class="track-cell track-cell-left">
              <span class="track-name">${track.title}</span>
              </div>
              <div class="track-cell track-cell-center">
              <span class="track-category-pill">${track.category || ''}</span>
              </div>
              <div class="track-cell track-cell-right">
              <span class="track-duration">${track.duration}</span>
           </div>
        </div>
        <div class="add-to-mixer-btn" title="Add to mixer">
            <i class="fas fa-sliders-h"></i>
        </div>
        <div class="remove-track">
            <i class="fas fa-times"></i>
        </div>
        `;
          // Play track on click
          item.addEventListener('click', function(e) {
            if (!e.target.closest('.remove-track') && !e.target.closest('.add-to-mixer-btn')) {
              currentTrackIndex = index;
              loadTrack(currentTrackIndex);
              playTrack();
            }
          });
          // Add to mixer button
          const addToMixerBtn = item.querySelector('.add-to-mixer-btn');
          addToMixerBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            addToMixer(track);
            // Visual feedback
            this.innerHTML = '<i class="fas fa-check"></i>';
            this.style.color = '#2ecc71';
            setTimeout(() => {
              this.innerHTML = '<i class="fas fa-sliders-h"></i>';
              this.style.color = '';
            }, 1000);
          });
          // Remove track on button click
          const removeBtn = item.querySelector('.remove-track');
          removeBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            removeTrack(index);
          });
          // Drag and drop functionality
          item.addEventListener('dragstart', handleDragStart);
          item.addEventListener('dragover', handleDragOver);
          item.addEventListener('drop', handleDrop);
          item.addEventListener('dragend', handleDragEnd);
          playlistItems.appendChild(item);
        });
        syncEditingPlaylist();
      }
            function renderSavedPlaylists() {
        savedPlaylistsList.innerHTML = '';
        const savedEntries = Object.entries(savedPlaylists);
        if (savedEntries.length === 0) {
          const emptyItem = document.createElement('li');
          emptyItem.className = 'saved-playlists-empty';
          emptyItem.textContent = 'No saved playlists yet.';
          savedPlaylistsList.appendChild(emptyItem);
          return;
        }
        savedEntries.forEach(([name, data]) => {
          // data = { type: 'all'|'music'|'video', tracks: [...], videos: [...] }
          const trackCount = (data.tracks || []).length;
          const videoCount = (data.videos || []).length;
          const saveType = data.type || 'music';

          const item = document.createElement('li');
          item.className = `saved-playlist-item${name === editingPlaylistName ? ' editing' : ''}`;
          const details = document.createElement('div');
          details.className = 'saved-playlist-details';
          const title = document.createElement('span');
          title.className = 'saved-playlist-name';
          title.innerHTML = name;
          // Type badge
          const badgeClass = saveType === 'all' ? 'type-all' : saveType === 'video' ? 'type-video' : 'type-music';
          const badgeLabel = saveType === 'all' ? 'All' : saveType === 'video' ? 'Video' : 'Music';
          title.innerHTML += ` <span class="saved-playlist-type-badge ${badgeClass}">${badgeLabel}</span>`;

          const meta = document.createElement('span');
          meta.className = 'saved-playlist-meta';
          const parts = [];
          if (trackCount > 0) parts.push(`${trackCount} track${trackCount !== 1 ? 's' : ''}`);
          if (videoCount > 0) parts.push(`${videoCount} video${videoCount !== 1 ? 's' : ''}`);
          meta.textContent = parts.join(', ') || 'Empty';
          details.appendChild(title);
          details.appendChild(meta);
          const actions = document.createElement('div');
          actions.className = 'saved-playlist-actions';
          const loadBtn = document.createElement('button');
          loadBtn.textContent = 'Load';
          const editBtn = document.createElement('button');
          editBtn.textContent = 'Edit';
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete';
          deleteBtn.textContent = 'Delete';
          actions.appendChild(loadBtn);
          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);
          item.appendChild(details);
          item.appendChild(actions);
          loadBtn.addEventListener('click', function() {
            setEditingPlaylist(null);
            // Load tracks if present
            if (data.tracks && data.tracks.length > 0) {
              loadPlaylistTracks(data.tracks);
            }
            // Load videos if present
            if (data.videos && data.videos.length > 0) {
              loadPlaylistVideos(data.videos);
            }
          });
          editBtn.addEventListener('click', function() {
            setEditingPlaylist(name);
            if (data.tracks && data.tracks.length > 0) {
              loadPlaylistTracks(data.tracks);
            }
            if (data.videos && data.videos.length > 0) {
              loadPlaylistVideos(data.videos);
            }
          });
          deleteBtn.addEventListener('click', function() {
            showDeleteConfirm(name);
          });
          savedPlaylistsList.appendChild(item);
        });
      }
      function saveCurrentPlaylist(saveType) {
        saveType = saveType || currentSaveType;
        const name = playlistNameInput.value.trim();
        if (!name) {
          alert('Please enter a playlist name.');
          return;
        }
        const musicTracks = playlist.map(t => ({...t}));
        const vids = (typeof videoPlaylist !== 'undefined' ? videoPlaylist : []).map(v => ({...v}));
        
        let tracksToSave = [];
        let videosToSave = [];
        if (saveType === 'all') {
          tracksToSave = musicTracks;
          videosToSave = vids;
        } else if (saveType === 'music') {
          tracksToSave = musicTracks;
        } else if (saveType === 'video') {
          videosToSave = vids;
        }
        
        if (tracksToSave.length === 0 && videosToSave.length === 0) {
          alert('Nothing to save. Add tracks or videos to your playlist first.');
          return;
        }
        
        const entry = { type: saveType, tracks: tracksToSave, videos: videosToSave };
        
        if (editingPlaylistName) {
          if (name !== editingPlaylistName && savedPlaylists[name] && !confirm(`"${name}" already exists. Overwrite?`)) {
            return;
          }
          if (name !== editingPlaylistName) {
            delete savedPlaylists[editingPlaylistName];
            editingPlaylistName = name;
          }
          savedPlaylists[name] = entry;
          setEditingPlaylist(editingPlaylistName);
        } else {
          if (savedPlaylists[name] && !confirm(`"${name}" already exists. Overwrite?`)) {
            return;
          }
          savedPlaylists[name] = entry;
          playlistNameInput.value = '';
        }
        savePlaylistsToStorage();
        renderSavedPlaylists();
      }
      // Remove track from playlist
      function removeTrack(index) {
        if (index < 0 || index >= playlist.length) return;
        // If we're removing the currently playing track
        if (index === currentTrackIndex) {
          if (isPlaying) pauseTrack();
          // If it's the last track in the playlist
          if (playlist.length === 1) {
            clearPlaylist();
            return;
          }
          // If it's the last track but there are others
          if (currentTrackIndex === playlist.length - 1) {
            currentTrackIndex--;
          }
          loadTrack(currentTrackIndex);
        }
        // If we're removing a track before the current one
        else if (index < currentTrackIndex) {
          currentTrackIndex--;
        }
        playlist.splice(index, 1);
        updatePlaylistDisplay();
      }
      // Clear playlist
      function clearPlaylist() {
        if (playlist.length === 0) return;
        if (confirm("Are you sure you want to clear the entire playlist?")) {
          playlist = [];
          currentTrackIndex = -1;
          audioPlayer.src = '';
          currentTrackDisplay.textContent = 'No Track Selected';
          currentCategoryDisplay.textContent = '';
          currentTimeDisplay.textContent = '0:00';
          durationDisplay.textContent = '0:00';
          progressBar.value = 0;
          pauseTrack();
          updatePlaylistDisplay();
        }
      }
      // Load track
      function loadTrack(index) {
        if (index < 0 || index >= playlist.length) return;
        // Remember if video was playing before track change
        const ambianceVid = document.getElementById('ambiance-video');
        const videoWasPlaying = ambianceVid && !ambianceVid.paused && ambianceVid.src && ambianceVid.src !== window.location.href;
        currentTrackIndex = index;
        audioPlayer.src = playlist[index].src;
        currentTrackDisplay.textContent = playlist[index].title;
        // Update current category display (if track provides category)
        if (playlist[index].category) {
          currentCategoryDisplay.textContent = `• ${playlist[index].category}`;
        } else {
          currentCategoryDisplay.textContent = '';
        }
        updatePlaylistDisplay();
        // If the player was already playing, continue playback
        if (isPlaying) {
          audioPlayer.play().catch(error => {
            console.error('Playback failed:', error);
          });
        }
        // Resume video if it was playing before track change
        if (videoWasPlaying && ambianceVid.paused) {
          ambianceVid.play().catch(() => {});
        }
      }
      // Play track
      function playTrack() {
        if (playlist.length === 0) return;
        if (currentTrackIndex === -1) {
          currentTrackIndex = 0;
          loadTrack(currentTrackIndex);
        }
        audioPlayer.play()
          .then(() => {
            isPlaying = true;
            playBtn.innerHTML = '<i class="fas fa-pause"></i>';
            playBtn.classList.add('pulse');
            // Record listen history
            if (playlist[currentTrackIndex]) recordListenHistory(playlist[currentTrackIndex]);
          })
          .catch(error => {
            console.error("Playback failed:", error);
          });
      }
      // Pause track
      function pauseTrack() {
        audioPlayer.pause();
        isPlaying = false;
        playBtn.innerHTML = '<i class="fas fa-play"></i>';
        playBtn.classList.remove('pulse');
      }
      // Next track
      function nextTrack() {
        if (isLooping) {
          audioPlayer.currentTime = 0;
          audioPlayer.play();
          return;
        }
        if (currentTrackIndex < playlist.length - 1) {
          currentTrackIndex++;
        } else {
          currentTrackIndex = 0; // Loop back to beginning
        }
        loadTrack(currentTrackIndex);
        if (isPlaying) playTrack();
      }
      // Previous track
      function prevTrack() {
        if (audioPlayer.currentTime > 3) {
          // If more than 3 seconds into the track, restart it
          audioPlayer.currentTime = 0;
        } else {
          // Otherwise go to previous track
          if (currentTrackIndex > 0) {
            currentTrackIndex--;
          } else {
            currentTrackIndex = playlist.length - 1; // Go to last track
          }
          loadTrack(currentTrackIndex);
        }
        if (isPlaying) playTrack();
      }
      // Format time
      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
      }
      // Shuffle playlist
      function shufflePlaylist() {
        if (playlist.length < 2) return;
        // Fisher-Yates shuffle algorithm
        for (let i = playlist.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [playlist[i], playlist[j]] = [playlist[j], playlist[i]];
        }
        // Update current track index if playing
        if (currentTrackIndex >= 0) {
          const currentTrack = playlist.find(track => track.title === currentTrackDisplay.textContent);
          currentTrackIndex = playlist.indexOf(currentTrack);
        }
        updatePlaylistDisplay();
        // Visual feedback
        shuffleBtn.style.backgroundColor = '#2ecc71';
        shuffleBtn.style.color = 'white';
        setTimeout(() => {
          shuffleBtn.style.backgroundColor = '';
          shuffleBtn.style.color = '';
        }, 500);
      }
      // Drag and drop functions
      let draggedItem = null;
      function handleDragStart(e) {
        draggedItem = this;
        this.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
      }
      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
      }
      function handleDrop(e) {
        e.stopPropagation();
        e.preventDefault();
        if (draggedItem !== this) {
          const fromIndex = parseInt(draggedItem.dataset.index);
          const toIndex = parseInt(this.dataset.index);
          // Reorder playlist array
          const [movedItem] = playlist.splice(fromIndex, 1);
          playlist.splice(toIndex, 0, movedItem);
          // Update current track index if needed
          if (currentTrackIndex === fromIndex) {
            currentTrackIndex = toIndex;
          } else if (fromIndex < currentTrackIndex && toIndex >= currentTrackIndex) {
            currentTrackIndex--;
          } else if (fromIndex > currentTrackIndex && toIndex <= currentTrackIndex) {
            currentTrackIndex++;
          }
          updatePlaylistDisplay();
        }
        return false;
      }
      function handleDragEnd(e) {
        this.style.opacity = '1';
      }
      // Event listeners
      playBtn.addEventListener('click', function() {
        if (isPlaying) {
          pauseTrack();
        } else {
          playTrack();
        }
      });
      nextBtn.addEventListener('click', nextTrack);
      prevBtn.addEventListener('click', prevTrack);
      clearBtn.addEventListener('click', clearPlaylist);
      shuffleBtn.addEventListener('click', shufflePlaylist);
      loopBtn.addEventListener('click', function() {
        isLooping = !isLooping;
        audioPlayer.loop = isLooping;
        loopBtn.classList.toggle('active', isLooping);
      });

      savePlaylistBtn.addEventListener('click', function() { saveCurrentPlaylist(currentSaveType); });
      // Save dropdown toggle
      saveDropdownToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        saveDropdownMenu.classList.toggle('show');
      });
      // Save dropdown menu items
      saveDropdownMenu.querySelectorAll('button[data-save-type]').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          currentSaveType = this.dataset.saveType;
          const labels = { all: 'Save All', music: 'Save Music', video: 'Save Video' };
          savePlaylistBtn.textContent = editingPlaylistName ? 'Update' : labels[currentSaveType];
          saveDropdownMenu.classList.remove('show');
          saveCurrentPlaylist(currentSaveType);
        });
      });
      // Close dropdown when clicking outside
      document.addEventListener('click', function() {
        saveDropdownMenu.classList.remove('show');
      });
      playlistNameInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          saveCurrentPlaylist(currentSaveType);
        }
      });
      doneEditBtn.addEventListener('click', function() {
        setEditingPlaylist(null);
      });
      // Progress bar
      progressBar.addEventListener('input', function() {
        if (!isNaN(audioPlayer.duration)) {
          const time = (this.value / 100) * audioPlayer.duration;
          audioPlayer.currentTime = time;
        }
      });
      // Volume control
      volumeBar.addEventListener('input', function() {
        audioPlayer.volume = this.value / 100;
        // Update volume icon based on level
        const volumeDownIcon = document.querySelector('.volume-control .fa-volume-down');
        const volumeUpIcon = document.querySelector('.volume-control .fa-volume-up');
        if (this.value == 0) {
          volumeDownIcon.className = 'fas fa-volume-mute';
          volumeUpIcon.style.opacity = '0.5';
        } else if (this.value < 50) {
          volumeDownIcon.className = 'fas fa-volume-down';
          volumeUpIcon.style.opacity = '0.5';
        } else {
          volumeDownIcon.className = 'fas fa-volume-down';
          volumeUpIcon.style.opacity = '1';
        }
      });
      // Time updates
      audioPlayer.addEventListener('timeupdate', function() {
        if (!isNaN(audioPlayer.duration)) {
          const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
          progressBar.value = isNaN(progress) ? 0 : progress;
          currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime);
          durationDisplay.textContent = formatTime(audioPlayer.duration);
        }
      });
      // Track ended
      audioPlayer.addEventListener('ended', function() {
        if (isLooping) {
          audioPlayer.currentTime = 0;
          audioPlayer.play();
        } else {
          nextTrack();
        }
      });
      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        // Spacebar to play/pause
        if (e.code === 'Space' && !e.target.matches('input, textarea')) {
          e.preventDefault();
          if (isPlaying) {
            pauseTrack();
          } else {
            playTrack();
          }
        }
        // Right arrow for next track
        if (e.code === 'ArrowRight' && e.ctrlKey) {
          e.preventDefault();
          nextTrack();
        }
        // Left arrow for previous track
        if (e.code === 'ArrowLeft' && e.ctrlKey) {
          e.preventDefault();
          prevTrack();
        }
      });
      // Initialize the player
      initializeLibrary();
      renderSavedPlaylists();
      renderTrash();

      // ── Dark Mode (default ON) ──
      const savedDarkMode = localStorage.getItem('audiooasis.darkMode');
      if (savedDarkMode !== 'false') {
        document.body.classList.add('dark-mode');
        darkModeToggle.querySelector('i').className = 'fas fa-sun';
      }
      darkModeToggle.addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        this.querySelector('i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        localStorage.setItem('audiooasis.darkMode', isDark);
      });

      // ── Library Search ──
      let searchTimeout;
      librarySearchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => filterLibrary(this.value), 150);
        searchClearBtn.classList.toggle('visible', this.value.length > 0);
      });
      searchClearBtn.addEventListener('click', function() {
        librarySearchInput.value = '';
        searchClearBtn.classList.remove('visible');
        filterLibrary('');
        librarySearchInput.focus();
      });
      function filterLibrary(query) {
        const q = query.toLowerCase().trim();
        const isFavSearch = query === '♥';
        const categories = libraryElement.querySelectorAll('.category');
        let totalMatches = 0;
        let visibleCategories = 0;

        categories.forEach(cat => {
          const state = categoryVScrollState.get(cat);
          if (!state) return;
          const tracks = state.tracks;
          let categoryMatches = 0;

          if (isFavSearch) {
            // Filter to only favorited tracks
            const filtered = [];
            const hidden = new Set();
            tracks.forEach((track, idx) => {
              if (userFavorites.has(track.src)) {
                filtered.push(idx);
                categoryMatches++;
              } else {
                hidden.add(idx);
              }
            });
            state.filteredIndices = filtered;
            state.hiddenIndices = hidden;
          } else if (q) {
            // Build filtered indices
            const filtered = [];
            const hidden = new Set();
            tracks.forEach((track, idx) => {
              const searchText = (track.title.toLowerCase() + ' ' + state.categoryName.toLowerCase());
              if (searchText.includes(q)) {
                filtered.push(idx);
                categoryMatches++;
              } else {
                hidden.add(idx);
              }
            });
            state.filteredIndices = filtered;
            state.hiddenIndices = hidden;
          } else {
            state.filteredIndices = null;
            state.hiddenIndices = null;
            categoryMatches = tracks.length;
          }

          const hideCategory = (q || isFavSearch) && categoryMatches === 0;
          cat.classList.toggle('search-hidden', hideCategory);
          if (!hideCategory) visibleCategories++;
          totalMatches += categoryMatches;

          // Auto-expand categories with matches during search
          if ((q || isFavSearch) && categoryMatches > 0 && !cat.classList.contains('expanded')) {
            cat.classList.add('expanded');
            const toggleIcon = cat.querySelector('.category-toggle i');
            if (toggleIcon) toggleIcon.className = 'fas fa-chevron-up';
          }
          // Update visible track count
          const countSpan = cat.querySelector('.track-count');
          if (countSpan) {
            countSpan.textContent = (q || isFavSearch) ? `(${categoryMatches}/${tracks.length} tracks)` : `(${tracks.length} tracks)`;
          }

          // Force re-render virtual tracks with new filter
          state.renderedStart = -1;
          state.renderedEnd = -1;
          // Reset scroll to top when filtering
          const contentEl = cat.querySelector('.category-content');
          if (contentEl) contentEl.scrollTop = 0;
          if (cat.classList.contains('expanded')) {
            renderVirtualTracks(cat);
          }
        });

        if (q || isFavSearch) {
          const label = isFavSearch ? `Showing ${totalMatches} favorite${totalMatches !== 1 ? 's' : ''} in ${visibleCategories} categor${visibleCategories !== 1 ? 'ies' : 'y'}` :
            `Found ${totalMatches} track${totalMatches !== 1 ? 's' : ''} in ${visibleCategories} categor${visibleCategories !== 1 ? 'ies' : 'y'}`;
          searchStats.textContent = label;
          searchStats.classList.add('visible');
        } else {
          searchStats.classList.remove('visible');
        }
      }

      // ── Master Mixer Controls ──
      mixerPlayAll.addEventListener('click', function() {
        mixerTracks.forEach(track => {
          if (!track.isPlaying) {
            track.audio.play().catch(e => console.error('Mixer play failed:', e));
            track.isPlaying = true;
          }
        });
        updateMixerDisplay();
      });
      mixerPauseAll.addEventListener('click', function() {
        mixerTracks.forEach(track => {
          if (track.isPlaying) {
            track.audio.pause();
            track.isPlaying = false;
          }
        });
        updateMixerDisplay();
      });
      mixerStopAll.addEventListener('click', function() {
        mixerTracks.forEach(track => {
          track.audio.pause();
          track.audio.currentTime = 0;
          track.isPlaying = false;
        });
        updateMixerDisplay();
      });

      // ── Auto-detect Track Durations ──
      // Scan for tracks with "0:00" duration and fetch real duration from audio metadata
      // Uses a queue to limit concurrent requests and avoid bandwidth/memory spikes
      function autoDetectDurations() {
        const tracksToDetect = [];
        for (const [category, tracks] of Object.entries(trackLibrary)) {
          tracks.forEach(track => {
            if (track.duration === '0:00') {
              tracksToDetect.push(track);
            }
          });
        }
        if (tracksToDetect.length === 0) return;
        
        // Process max 3 at a time to avoid bandwidth spike
        let activeCount = 0;
        let queueIndex = 0;
        const MAX_CONCURRENT = 3;
        
        function processNext() {
          while (activeCount < MAX_CONCURRENT && queueIndex < tracksToDetect.length) {
            const track = tracksToDetect[queueIndex++];
            activeCount++;
            const tempAudio = new Audio();
            tempAudio.preload = 'metadata';
            const cleanup = () => {
              tempAudio.src = '';
              activeCount--;
              processNext();
            };
            tempAudio.addEventListener('loadedmetadata', function() {
              if (!isNaN(tempAudio.duration) && tempAudio.duration > 0) {
                track.duration = formatTime(tempAudio.duration);
              }
              cleanup();
            });
            tempAudio.addEventListener('error', cleanup);
            tempAudio.src = track.src;
          }
        }
        processNext();
      }
      // Run duration detection after a short delay to not block initial render
      setTimeout(autoDetectDurations, 2000);

      // ── Loading indicator for single player ──
      audioPlayer.addEventListener('waiting', function() {
        currentTrackDisplay.innerHTML = '<span class="track-loading"></span>' + (playlist[currentTrackIndex]?.title || 'Loading...');
      });
      audioPlayer.addEventListener('playing', function() {
        if (playlist[currentTrackIndex]) {
          currentTrackDisplay.textContent = playlist[currentTrackIndex].title;
        }
      });

      // All categories start collapsed — no auto-expand

      // ══════════════════════════════════════════════
      // ══════ VIDEO SYSTEM ══════
      // ══════════════════════════════════════════════

      // Video DOM elements
      const videoPlayerWrapper = document.getElementById('video-player-wrapper');
      const ambianceVideo = document.getElementById('ambiance-video');
      const videoNowPlaying = document.getElementById('video-now-playing');
      const videoPrevBtn = document.getElementById('video-prev-btn');
      const videoPlayPauseBtn = document.getElementById('video-playpause-btn');
      const videoNextBtn = document.getElementById('video-next-btn');
      const videoDetachBtn = document.getElementById('video-detach-btn');
      const videoFullscreenBtn = document.getElementById('video-fullscreen-btn');
      const videoCloseBtn = document.getElementById('video-close-btn');
      const videoSettings = document.getElementById('video-settings');
      const videoIntervalMode = document.getElementById('video-interval-mode');
      const videoIntervalTimeLabel = document.getElementById('video-interval-time-label');
      const videoIntervalMin = document.getElementById('video-interval-min');
      const videoIntervalSec = document.getElementById('video-interval-sec');
      const videoLoopToggle = document.getElementById('video-loop-toggle');
      // Playlist sub-tabs
      const tracksSubtab = document.getElementById('tracks-subtab');
      const videosSubtab = document.getElementById('videos-subtab');
      const tracksSubcontent = document.getElementById('tracks-subcontent');
      const videosSubcontent = document.getElementById('videos-subcontent');
      // Video playlist
      const videoPlaylistItems = document.getElementById('video-playlist-items');
      const emptyVideoPlaylist = document.getElementById('empty-video-playlist');
      // Video library
      const videoLibraryHeader = document.getElementById('video-library-header');
      const videoLibraryBody = document.getElementById('video-library-body');
      const videoLibraryToggle = document.getElementById('video-library-toggle');
      const videoGrid = document.getElementById('video-grid');
      // Ambiance overlay
      const ambianceOverlay = document.getElementById('video-ambiance-overlay');
      const ambianceVideoDetached = document.getElementById('ambiance-video-detached');
      const ambiancePrevBtn = document.getElementById('ambiance-prev-btn');
      const ambiancePlayPauseBtn = document.getElementById('ambiance-playpause-btn');
      const ambianceNextBtn = document.getElementById('ambiance-next-btn');
      const ambianceFullscreenBtn = document.getElementById('ambiance-fullscreen-btn');
      const ambianceCloseBtn = document.getElementById('ambiance-close-btn');

      // Video state
      let videoPlaylist = [];
      let currentVideoIndex = -1;
      let videoIsLooping = true;
      let videoIntervalTimer = null;
      let isAmbianceMode = false;

      // ── Playlist Sub-tabs ──
      tracksSubtab.addEventListener('click', function() {
        tracksSubtab.classList.add('active');
        videosSubtab.classList.remove('active');
        tracksSubcontent.classList.add('active');
        videosSubcontent.classList.remove('active');
      });
      videosSubtab.addEventListener('click', function() {
        videosSubtab.classList.add('active');
        tracksSubtab.classList.remove('active');
        videosSubcontent.classList.add('active');
        tracksSubcontent.classList.remove('active');
      });

      // ── Video Library Toggle ──
      videoLibraryHeader.addEventListener('click', function() {
        videoLibraryBody.classList.toggle('hidden');
        videoLibraryToggle.querySelector('i').className = videoLibraryBody.classList.contains('hidden')
          ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
      });

      // ── Video Library Grid View Toggle ──
      document.querySelectorAll('.video-view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.video-view-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          videoGrid.className = 'video-grid ' + this.dataset.view;
        });
      });

      // ── Initialize Video Library ──
      // Helper: get thumbnail path for a video src
      function getVideoThumbPath(videoSrc) {
        // videoSrc like "Video Files/Abstract - Cat with Blue Eyes.mp4"
        // thumb at "video_thumbs/Abstract - Cat with Blue Eyes.jpg"
        const filename = videoSrc.split('/').pop();
        const baseName = filename.replace(/\.[^.]+$/, '');
        return 'video_thumbs/' + baseName + '.jpg';
      }

      function initializeVideoLibrary() {
        if (typeof videoLibrary === 'undefined') return;
        videoGrid.innerHTML = '';
        for (const [category, videos] of Object.entries(videoLibrary)) {
          const label = document.createElement('div');
          label.className = 'video-category-label';
          label.textContent = `${category} (${videos.length})`;
          videoGrid.appendChild(label);

          videos.forEach(video => {
            const card = document.createElement('div');
            card.className = 'video-thumb-card';
            const thumbSrc = getVideoThumbPath(video.src);
            card.innerHTML = `
              <img src="${thumbSrc}" alt="${video.title}" loading="lazy">
              <i class="fas fa-play thumb-play-icon"></i>
              <div class="video-thumb-overlay">${video.title}</div>
              <div class="video-thumb-actions">
                <button class="vta-play" title="Play now"><i class="fas fa-play"></i></button>
                <button class="vta-add" title="Add to video playlist"><i class="fas fa-plus"></i></button>
              </div>
            `;
            // Play now
            card.querySelector('.vta-play').addEventListener('click', function(e) {
              e.stopPropagation();
              addToVideoPlaylist(video);
              const idx = videoPlaylist.length - 1;
              loadVideo(idx);
            });
            // Add to playlist
            card.querySelector('.vta-add').addEventListener('click', function(e) {
              e.stopPropagation();
              addToVideoPlaylist(video);
              this.innerHTML = '<i class="fas fa-check"></i>';
              setTimeout(() => { this.innerHTML = '<i class="fas fa-plus"></i>'; }, 800);
            });
            // Click card = play
            card.addEventListener('click', function() {
              addToVideoPlaylist(video);
              const idx = videoPlaylist.length - 1;
              loadVideo(idx);
            });
            videoGrid.appendChild(card);
          });
        }
      }

      // ── Video Playlist Management ──
      function addToVideoPlaylist(video) {
        videoPlaylist.push({ ...video });
        updateVideoPlaylistDisplay();
        // Show video player if hidden
        videoPlayerWrapper.classList.remove('hidden');
        videoSettings.classList.remove('hidden');
        // If first video, load it
        if (videoPlaylist.length === 1) {
          currentVideoIndex = 0;
          loadVideo(0);
        }
        // Switch to videos subtab
        videosSubtab.click();
      }

      // Override loadPlaylistVideos now that video system is ready
      loadPlaylistVideos = function(videos) {
        videoPlaylist = [];
        currentVideoIndex = -1;
        ambianceVideo.src = '';
        videos.forEach(v => videoPlaylist.push({...v}));
        updateVideoPlaylistDisplay();
        if (videoPlaylist.length > 0) {
          videoPlayerWrapper.classList.remove('hidden');
          videoSettings.classList.remove('hidden');
          currentVideoIndex = 0;
          loadVideo(0);
          videosSubtab.click();
        } else {
          videoPlayerWrapper.classList.add('hidden');
          videoSettings.classList.add('hidden');
          videoNowPlaying.textContent = 'No video';
        }
      };
      // Process any pending video load from before video system was ready
      if (window._pendingVideoLoad) {
        loadPlaylistVideos(window._pendingVideoLoad);
        delete window._pendingVideoLoad;
      }

      function removeFromVideoPlaylist(index) {
        if (index === currentVideoIndex) {
          if (videoPlaylist.length === 1) {
            videoPlaylist = [];
            currentVideoIndex = -1;
            ambianceVideo.src = '';
            videoPlayerWrapper.classList.add('hidden');
            videoSettings.classList.add('hidden');
            videoNowPlaying.textContent = 'No video';
          } else {
            videoPlaylist.splice(index, 1);
            if (currentVideoIndex >= videoPlaylist.length) currentVideoIndex = 0;
            loadVideo(currentVideoIndex);
          }
        } else {
          if (index < currentVideoIndex) currentVideoIndex--;
          videoPlaylist.splice(index, 1);
        }
        updateVideoPlaylistDisplay();
      }

      function updateVideoPlaylistDisplay() {
        videoPlaylistItems.innerHTML = '';
        if (videoPlaylist.length === 0) {
          emptyVideoPlaylist.classList.remove('hidden');
          return;
        }
        emptyVideoPlaylist.classList.add('hidden');
        videoPlaylist.forEach((video, index) => {
          const item = document.createElement('li');
          item.className = `video-playlist-item${index === currentVideoIndex ? ' active' : ''}`;
          const thumbSrc = getVideoThumbPath(video.src);
          item.innerHTML = `
            <span class="vpi-index">${index + 1}</span>
            <img class="vpi-thumb" src="${thumbSrc}" alt="${video.title}">
            <span class="vpi-title">${video.title}</span>
            <button class="vpi-remove" title="Remove"><i class="fas fa-times"></i></button>
          `;
          // Click to play
          item.addEventListener('click', function(e) {
            if (e.target.closest('.vpi-remove')) return;
            loadVideo(index);
          });
          // Remove
          item.querySelector('.vpi-remove').addEventListener('click', function(e) {
            e.stopPropagation();
            removeFromVideoPlaylist(index);
          });
          videoPlaylistItems.appendChild(item);
        });
      }

      // ── Video Player Controls (rewritten cleanly) ──

      function loadVideo(index) {
        if (index < 0 || index >= videoPlaylist.length) return;
        currentVideoIndex = index;
        const video = videoPlaylist[index];
        videoNowPlaying.textContent = video.title;
        updateVideoPlaylistDisplay();

        // Set source and let the browser handle loading
        ambianceVideo.src = video.src;

        // Sync detached video if ambiance mode is active
        if (isAmbianceMode) {
          ambianceVideoDetached.src = video.src;
        }

        // Show player
        videoPlayerWrapper.classList.remove('hidden');
        videoSettings.classList.remove('hidden');

        // Play once the browser has enough data
        playVideo();
      }

      function playVideo() {
        // Simple play: the video is muted + playsinline so mobile should allow it
        var promise = ambianceVideo.play();
        if (promise !== undefined) {
          promise.catch(function() {
            // Browser blocked play — wait for data then try once more
            function retry() {
              ambianceVideo.removeEventListener('canplay', retry);
              ambianceVideo.play().catch(function() {});
            }
            ambianceVideo.addEventListener('canplay', retry);
          });
        }
      }

      function pauseVideo() {
        ambianceVideo.pause();
      }

      function nextVideo() {
        if (videoPlaylist.length === 0) return;
        currentVideoIndex = (currentVideoIndex + 1) % videoPlaylist.length;
        loadVideo(currentVideoIndex);
      }

      function prevVideo() {
        if (videoPlaylist.length === 0) return;
        currentVideoIndex = (currentVideoIndex - 1 + videoPlaylist.length) % videoPlaylist.length;
        loadVideo(currentVideoIndex);
      }

      // Sync the play/pause button icon from native video events
      ambianceVideo.addEventListener('playing', function() {
        videoPlayPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
      });
      ambianceVideo.addEventListener('pause', function() {
        videoPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
      });

      // When video ends: loop single, or advance playlist
      ambianceVideo.addEventListener('ended', function() {
        if (videoPlaylist.length <= 1 && videoIsLooping) {
          ambianceVideo.currentTime = 0;
          playVideo();
        } else if (videoPlaylist.length > 1) {
          nextVideo();
        }
      });

      // Player control buttons
      videoPlayPauseBtn.addEventListener('click', function() {
        if (ambianceVideo.paused) playVideo();
        else pauseVideo();
      });
      videoNextBtn.addEventListener('click', nextVideo);
      videoPrevBtn.addEventListener('click', prevVideo);

      videoCloseBtn.addEventListener('click', function() {
        pauseVideo();
        videoPlayerWrapper.classList.add('hidden');
        videoSettings.classList.add('hidden');
      });

      videoFullscreenBtn.addEventListener('click', function() {
        if (videoPlayerWrapper.requestFullscreen) videoPlayerWrapper.requestFullscreen();
        else if (videoPlayerWrapper.webkitRequestFullscreen) videoPlayerWrapper.webkitRequestFullscreen();
      });

      // ── Video Interval Mode ──
      videoIntervalMode.addEventListener('change', function() {
        clearInterval(videoIntervalTimer);
        videoIntervalTimeLabel.classList.toggle('hidden', this.value !== 'timed');
        if (this.value === 'timed') startTimedInterval();
      });

      function startTimedInterval() {
        clearInterval(videoIntervalTimer);
        var min = parseInt(videoIntervalMin.value) || 0;
        var sec = parseInt(videoIntervalSec.value) || 0;
        var ms = (min * 60 + sec) * 1000;
        if (ms < 5000) return;
        videoIntervalTimer = setInterval(nextVideo, ms);
      }

      videoIntervalMin.addEventListener('change', function() {
        if (videoIntervalMode.value === 'timed') startTimedInterval();
      });
      videoIntervalSec.addEventListener('change', function() {
        if (videoIntervalMode.value === 'timed') startTimedInterval();
      });

      // Per-track mode: advance video when a music track starts
      audioPlayer.addEventListener('play', function() {
        if (videoIntervalMode.value === 'per-track' && videoPlaylist.length > 1) {
          nextVideo();
        }
      });

      // Loop toggle
      videoLoopToggle.addEventListener('click', function() {
        videoIsLooping = !videoIsLooping;
        this.classList.toggle('active', videoIsLooping);
      });

      // ── Ambiance / Detach Mode ──
      videoDetachBtn.addEventListener('click', function() {
        isAmbianceMode = true;
        ambianceOverlay.classList.add('active');
        ambianceVideoDetached.src = ambianceVideo.src;
        ambianceVideoDetached.currentTime = ambianceVideo.currentTime;
        ambianceVideoDetached.play().catch(function() {});
        ambiancePlayPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
      });

      ambianceCloseBtn.addEventListener('click', function() {
        isAmbianceMode = false;
        ambianceOverlay.classList.remove('active');
        ambianceVideoDetached.pause();
        ambianceVideoDetached.removeAttribute('src');
        ambianceVideoDetached.load();
      });

      ambiancePlayPauseBtn.addEventListener('click', function() {
        if (ambianceVideoDetached.paused) {
          ambianceVideoDetached.play().catch(function() {});
          this.innerHTML = '<i class="fas fa-pause"></i>';
        } else {
          ambianceVideoDetached.pause();
          this.innerHTML = '<i class="fas fa-play"></i>';
        }
      });

      ambiancePrevBtn.addEventListener('click', function() {
        prevVideo();
        if (isAmbianceMode) {
          ambianceVideoDetached.src = ambianceVideo.src;
          ambianceVideoDetached.play().catch(function() {});
        }
      });
      ambianceNextBtn.addEventListener('click', function() {
        nextVideo();
        if (isAmbianceMode) {
          ambianceVideoDetached.src = ambianceVideo.src;
          ambianceVideoDetached.play().catch(function() {});
        }
      });

      ambianceFullscreenBtn.addEventListener('click', function() {
        if (ambianceOverlay.requestFullscreen) ambianceOverlay.requestFullscreen();
        else if (ambianceOverlay.webkitRequestFullscreen) ambianceOverlay.webkitRequestFullscreen();
      });

      ambianceVideoDetached.addEventListener('ended', function() {
        if (videoPlaylist.length <= 1 && videoIsLooping) {
          ambianceVideoDetached.currentTime = 0;
          ambianceVideoDetached.play().catch(function() {});
        } else if (videoPlaylist.length > 1) {
          nextVideo();
          if (isAmbianceMode) {
            ambianceVideoDetached.src = ambianceVideo.src;
            ambianceVideoDetached.play().catch(function() {});
          }
        }
      });

      // ESC to close ambiance
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && isAmbianceMode) {
          ambianceCloseBtn.click();
        }
      });

      // Music library toggle
      const musicLibraryHeader = document.getElementById('music-library-header');
      const musicLibraryBody = document.querySelector('.library-body');
      const musicLibraryToggle = document.getElementById('music-library-toggle');
      musicLibraryHeader.addEventListener('click', function() {
        const isHidden = musicLibraryBody.style.display === 'none';
        musicLibraryBody.style.display = isHidden ? '' : 'none';
        musicLibraryToggle.querySelector('i').className = isHidden ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
      });

      // Initialize video library
      initializeVideoLibrary();
    });
  </script>
</body>
</html>
